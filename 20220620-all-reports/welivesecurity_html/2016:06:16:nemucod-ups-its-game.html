<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/css/main-8633bd3c28.css" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Guest Writer',
        'ArticleCategory': 'Malware',
        'ArticleSection': '(not set)',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>
<script>(function() {
  var _fbq = window._fbq || (window._fbq = []);
  if (!_fbq.loaded) {
    var fbds = document.createElement('script');
    fbds.async = true;
    fbds.src = '//connect.facebook.net/en_US/fbds.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(fbds, s);
    _fbq.loaded = true;
  }
  _fbq.push(['addPixelId', '1518099328403839']);
})();
window._fbq = window._fbq || [];
window._fbq.push(['track', 'PixelInitialized', {}]);
</script>
<noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?id=1518099328403839&amp;ev=NoScript" /></noscript>
<meta property="fb:pages" content="56844830907" />
<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>Nemucod ups its game | WeLiveSecurity</title>
<meta name="description" content="The creators of Nemucod, the code responsible for downloading and executing malware like Locky, have been hard at work polishing their code."/>
<link rel="canonical" href="https://www.welivesecurity.com/2016/06/16/nemucod-ups-its-game/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Nemucod ups its game | WeLiveSecurity" />
<meta property="og:description" content="The creators of Nemucod, the code responsible for downloading and executing malware like Locky, have been hard at work polishing their code." />
<meta property="og:url" content="https://www.welivesecurity.com/2016/06/16/nemucod-ups-its-game/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2016-06-16T12:30:17+00:00" />
<meta property="article:modified_time" content="2017-06-14T17:46:03+00:00" />
<meta property="og:updated_time" content="2017-06-14T17:46:03+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-ups-its-game.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-ups-its-game.jpg" />
<meta property="og:image:width" content="1000" />
<meta property="og:image:height" content="667" />
<meta property="og:image:alt" content="Nemucod ups its game" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="The creators of Nemucod, the code responsible for downloading and executing malware like Locky, have been hard at work polishing their code." />
<meta name="twitter:title" content="Nemucod ups its game | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-ups-its-game.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel="alternate" href="https://www.welivesecurity.com/2016/06/16/nemucod-ups-its-game/" hreflang="en" />
<link rel="alternate" href="https://www.welivesecurity.com/la-es/2016/06/16/nemucod-probabilidades-infeccion/" hreflang="es" />
<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single noimage">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2016/06/16/nemucod-probabilidades-infeccion/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/2016/06/16/nemucod-probabilidades-infeccion/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong> 
					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-noimage">
	<div class="container promo-text">
		<div class="inner clearfix">
			<div class="col-md-11 col-sm-11 col-xs-12 no-padding">
				<h1>Nemucod ups its game</h1>
<div class="excerpt">The creators of Nemucod, the code responsible for downloading and executing malware like Locky, have been hard at work polishing their code. </div>
<div class="post-meta">
    <div class="wls-authors">
                <div class="wls-author with-avatar">
                            <div class="wls-author-avatar">
                    <a href="https://www.welivesecurity.com/author/guestwriter/" title="Guest Writer">
                        <img src="https://www.welivesecurity.com/wp-content/uploads/2013/12/pen-tip-200-222x179.png" alt="Guest Writer">
                    </a>
                </div>
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/guestwriter/" title="Guest Writer">
                    Guest Writer                </a>
            </div>
        </div>
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2016-06-16 14:30:17">16 Jun 2016 - 02:30PM</time>
		</span>
			</span>
</div>
			</div>
		</div>
	</div>
</div>	

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2016%2F06%2F16%2Fnemucod-ups-its-game%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2016%2F06%2F16%2Fnemucod-ups-its-game%2F&text=Nemucod ups its game%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2016%2F06%2F16%2Fnemucod-ups-its-game%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt noimage">
                                <p>The creators of Nemucod, the code responsible for downloading and executing malware like Locky, have been hard at work polishing their code. </p>
                            </div>

                            <p>Some time ago, we detailed <a href="/2016/04/04/analysis-of-the-locky-infection-process/" target="_blank" rel="noopener noreferrer">how the Locky ransomware infection process works</a>. Since then, the creators of the Nemucod “downloader” (the code responsible for downloading and executing malware like Locky) have been hard at work polishing their code.</p>
<p>One of the latest versions of Nemucod shows some notable changes over the older versions. In the past, the process was pretty simple: “User opens malicious file → File downloads payload → payload gets executed”. In the more recent versions however, it’s somewhat less straightforward.</p>
<p>Let’s have a look at what the code does in more detail. To make it more readable, this code was deobfuscated from its heavily obfuscated original format.</p>
<h2>Step 1 – Choosing the right connection method</h2>
<p>Earlier versions of Nemucod only used one method to connect to the internet. However, this could fail because of different infrastructure configurations (Windows version, proxy servers, etc).</p>
<p>To provide greater compatibility, the authors of Nemucod created a function that tries to connect using multiple methods:</p>
<p><img class="aligncenter wp-image-80569" src="/wp-content/uploads/2016/06/Nemucod-–-1.png" alt="Nemucod – 1" width="639" height="277" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-1.png 824w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-1-300x130.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-1-768x333.png 768w" sizes="(max-width: 639px) 100vw, 639px" /></p>
<p>The first method to work is the one that gets used.</p>
<h2>Step 2 – Trying different download sites</h2>
<p>Until now, Nemucod came with one address (usually a compromised webserver) from which to try to download its payload. This was a single point of failure; once that payload was removed, the attack would fail. Perhaps with the hope of increasing its chances of success, recent versions have included multiple download locations, as seen in these examples:</p>
<p><img class="aligncenter wp-image-80570" src="/wp-content/uploads/2016/06/Nemucod-–-2.png" alt="Nemucod – 2" width="636" height="146" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-2.png 636w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-2-300x69.png 300w" sizes="(max-width: 636px) 100vw, 636px" /></p>
<p><img class="aligncenter size-full wp-image-80571" src="/wp-content/uploads/2016/06/Nemucod-–-3.png" alt="Nemucod – 3" width="502" height="138" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-3.png 502w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-3-300x82.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-3-500x138.png 500w" sizes="(max-width: 502px) 100vw, 502px" /></p>
<p>The code cycles through the list of sites until one succeeds:</p>
<p><img class="aligncenter wp-image-80572" src="/wp-content/uploads/2016/06/Nemucod-–-4.png" alt="Nemucod – 4" width="638" height="192" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-4.png 945w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-4-300x90.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-4-768x231.png 768w" sizes="(max-width: 638px) 100vw, 638px" /></p>
<h2>Step 3 – First round of deobfuscation</h2>
<p>In the past, the payloads downloaded by Nemucod were regular “.exe” binary files. These could then be directly executed. However, downloading “.exe” files meant that devices such as stateful firewalls, IDSes and UTMs were able to intercept the payload for a security scan – or even reject it.</p>
<p>To avoid such possible snags, the latest version of Nemucod downloads an obfuscated file. First, it downloads the file to the victim’s %TEMP% directory:</p>
<p><img class="aligncenter wp-image-80568" src="/wp-content/uploads/2016/06/Nemucod-–-5.png" alt="Nemucod – 5" width="637" height="101" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-5.png 750w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-5-300x48.png 300w" sizes="(max-width: 637px) 100vw, 637px" /></p>
<p><img class="aligncenter wp-image-80573" src="/wp-content/uploads/2016/06/Nemucod-–-6.png" alt="Nemucod – 6" width="639" height="185" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-6.png 677w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-6-300x87.png 300w" sizes="(max-width: 639px) 100vw, 639px" /></p>
<p>After saving the obfuscated payload, this function passes the file content to a function that performs the first round of deobfuscation:</p>
<p><img class="aligncenter wp-image-80574" src="/wp-content/uploads/2016/06/Nemucod-–-7.png" alt="Nemucod – 7" width="639" height="347" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-7.png 715w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-7-300x163.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-7-143x79.png 143w" sizes="(max-width: 639px) 100vw, 639px" /></p>
<p>As it turns out, the first deobfuscation step is a simple substitution cipher. All characters in the file are converted to their decimal values. If a character’s decimal value is higher than 127, the character is replaced with its corresponding value from a pre-defined array of characters. If not, the character remains untouched:</p>
<p><img class="aligncenter size-full wp-image-80575" src="/wp-content/uploads/2016/06/Nemucod-–-8.png" alt="Nemucod – 8" width="590" height="605" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-8.png 590w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-8-293x300.png 293w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-8-32x32.png 32w" sizes="(max-width: 590px) 100vw, 590px" /></p>
<h2>Step 4 – Second round of deobfuscation</h2>
<p>After the first round of deobfuscation is completed, the file content is passed to a function that does a second round of deobfuscation. This round consists of three steps:</p>
<ul>
<li>Remove the last four characters from the file content</li>
<li>Perform an XOR operation on every character with the character “s” (0x73)</li>
<li>Reverse the file content</li>
</ul>
<p><img class="aligncenter size-full wp-image-80564" src="/wp-content/uploads/2016/06/Nemucod-–-9.png" alt="Nemucod – 9" width="541" height="272" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-9.png 541w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-9-300x151.png 300w" sizes="(max-width: 541px) 100vw, 541px" /></p>
<h2>Step 5 – Checking for validity</h2>
<p>At this point a rudimentary check of whether the resulting file content is a valid payload is performed. It checks whether the file size is between 174,080 and 189,440 bytes and the file starts with “MZ” (0x4D5A), the “magic bytes” of a portable executable (PE) file. If any of these comparisons fail, it jumps back to step two and tries to download a payload from the next download site:</p>
<p><img class="aligncenter wp-image-80561" src="/wp-content/uploads/2016/06/Nemucod-–-10.png" alt="Nemucod – 10" width="637" height="53" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-10.png 945w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-10-300x25.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-10-768x64.png 768w" sizes="(max-width: 637px) 100vw, 637px" /></p>
<p><img class="aligncenter wp-image-80562" src="/wp-content/uploads/2016/06/Nemucod-–-11.png" alt="Nemucod – 11" width="637" height="191" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-11.png 680w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-11-300x90.png 300w" sizes="(max-width: 637px) 100vw, 637px" /></p>
<h2>Step 6 – Final deobfuscation round</h2>
<p>If all checks pass, the file is written to the user&#8217;s %TEMP% folder:</p>
<p><img class="aligncenter size-full wp-image-80563" src="/wp-content/uploads/2016/06/Nemucod-–-12.png" alt="Nemucod – 12" width="468" height="146" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-12.png 468w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-12-300x94.png 300w" sizes="(max-width: 468px) 100vw, 468px" /></p>
<p><img class="aligncenter wp-image-80565" src="/wp-content/uploads/2016/06/Nemucod-–-13.png" alt="Nemucod – 13" width="641" height="229" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-13.png 711w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-13-300x107.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-13-420x149.png 420w" sizes="(max-width: 641px) 100vw, 641px" /></p>
<p>The function named deobRound3 during the deobfuscation process subjects the file content to another round of character substitution similar to the one in step 3. These character substitution rounds are most likely executed to avoid problems with “Wide Characters” during the second round of deobfuscation.</p>
<p>Finally, all characters are converted back from their decimal value and the file content should be a valid Windows executable file:</p>
<p><img class="aligncenter wp-image-80566" src="/wp-content/uploads/2016/06/Nemucod-–-14.png" alt="Nemucod – 14" width="640" height="659" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-14.png 690w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-14-291x300.png 291w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-14-32x32.png 32w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<h2>Step 7 &#8211; Execution</h2>
<p>Now that the payload is ready, it needs to be executed. Instead of running the “.exe” file directly, the newer versions of Nemucod creates a “.bat” file that starts the executable. It then executes the “.bat” file:</p>
<p><img class="aligncenter wp-image-80567" src="/wp-content/uploads/2016/06/Nemucod-–-15.png" alt="Nemucod – 15" width="640" height="272" srcset="https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-15.png 802w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-15-300x128.png 300w, https://www.welivesecurity.com/wp-content/uploads/2016/06/Nemucod-–-15-768x327.png 768w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>If “all goes well”, the user is now infected.</p>
<h2>Conclusion</h2>
<p>As you can see, the authors of Nemucod have been busy improving their downloader to increase the probability that it can run its malicious payload undetected. With all these new features, one can even speculate that they are working hard to improve their success rate in corporate environments, where proxy servers and UTM gateways may have been blocking their payloads in the past.</p>
<h2>Files researched</h2>
<p><strong>customers 366.wsf</strong> [<a href="http://www.virusradar.com/en/JS_TrojanDownloader.Nemucod.ABI/description" target="_blank" rel="noopener noreferrer">JS/TrojanDownloader.Nemucod.ABI troja</a>n]<br />
MD5: 4DEDF4085E6D2F74CB879AD2E9680AFB<br />
SHA1: EF2A9C6A61E98091A952328592D45214F6E44178</p>
<p><strong>cstomers 9679.js</strong> [<a href="http://www.virusradar.com/en/JS_TrojanDownloader.Nemucod.ABI/description" target="_blank" rel="noopener noreferrer">JS/TrojanDownloader.Nemucod.ABI trojan</a>]<br />
MD5: 42D054143A67DE14EE10F7B8C91D8A1A<br />
SHA1: D3DC6E3D066BFA8E1F4408DE471BC95B001D0D25</p>
<p><strong>Yhnpl47OMCLJm.exe</strong> [a variant of <a href="http://www.virusradar.com/en/Win32_Kryptik.EYIB/description" target="_blank" rel="noopener noreferrer">Win32/Kryptik.EYIB trojan</a>]<br />
MD5: C1F95ADBCAF520BF182F9014970D33E5<br />
SHA1: 80B96F0207B9C5D1DAA3A6E6CF646F5AFA7BBA2C</p>
<p>&#8212;</p>
<p><strong>Donny Maasland</strong><br />
<strong>Head of Cybersecurity Services and Research</strong><br />
<strong> ESET Netherlands</strong></p>
<p><em><span style="font-weight: 400;">The views and opinions expressed in this article are those of the author and do not necessarily reflect the official policy or position of WLS nor ESET.</span></em></p>

                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                <div class="wls-author">
                        <div class="wls-author-name">
                <a href="https://www.welivesecurity.com/author/guestwriter/" title="Guest Writer">
                    Guest Writer                </a>
            </div>
        </div>
                                            </div>
                                    <span class="strong">
								        <time datetime="2016-06-16 14:30:17">16 Jun 2016 - 02:30PM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    			
		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="//liondigital.us3.list-manage.com/subscribe/post?u=b76f82b1cc198ab1d80665c99&amp;id=102b0810e2" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
					<input type="text" name="email" value="" placeholder="Email...">
					<button>
						Submit					</button>
				</div>
			</form>		
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/cybercrime/" class="category-tag-btn">Cybercrime</a>                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/fbi-cybercrime-losses-2020-ic3-623x432.jpg"
                                                         alt="Nemucod ups its game">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/">
                                                    FBI: Cybercrime losses topped US$4.2 billion in 2020                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/exchange-servers-under-siege-10-apt-groups-623x432.jpg"
                                                         alt="Nemucod ups its game">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/">
                                                    Exchange servers under siege from at least 10 APT groups                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/apple-m1-macs-malware-1-623x432.jpg"
                                                         alt="Nemucod ups its game">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/">
                                                    Malware authors already taking aim at Apple M1 Macs                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/eset-kobalos-hpc-high-performance-computing-malware-research-623x432.jpg"
                                                         alt="Nemucod ups its game">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/">
                                                    Kobalos – A complex Linux threat to high performance computing infrastructure                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2016%2F06%2F16%2Fnemucod-ups-its-game%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2016%2F06%2F16%2Fnemucod-ups-its-game%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2016%2F06%2F16%2Fnemucod-ups-its-game%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/js/main-0ba0c3843d.js"></script>
    <!-- Version: v1.1.76.32619db9.pro-awus -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"80555 \/?p=80555","disqusShortname":"welivesecurity","disqusTitle":"Nemucod ups its game","disqusUrl":"https:\/\/www.welivesecurity.com\/2016\/06\/16\/nemucod-ups-its-game\/","postId":"80555"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>