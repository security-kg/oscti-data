<!doctype html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="google-site-verification" content="_b2avZwzr79oru6lM2Ddae1fNpSIbPaP0H0WNkc2x3k"/>
    <meta name="msvalidate.01" content="CE77828A466C2513F660017CFCB6BA13"/>
    <link rel="icon" href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/favicon.ico">

    

            
    
    <link href="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/css/main-8633bd3c28.css" rel="stylesheet">
    <script type="text/javascript"> var appInsights=window.appInsights||function(a){ function b(a){c[a]=function(){var b=arguments;c.queue.push(function(){c[a].apply(c,b)})}}var c={config:a},d=document,e=window;setTimeout(function(){var b=d.createElement("script");b.src=a.url||"https://az416426.vo.msecnd.net/scripts/a/ai.0.js",d.getElementsByTagName("script")[0].parentNode.appendChild(b)});try{c.cookie=d.cookie}catch(a){}c.queue=[];for(var f=["Event","Exception","Metric","PageView","Trace","Dependency"];f.length;)b("track"+f.pop());if(b("setAuthenticatedUserContext"),b("clearAuthenticatedUserContext"),b("startTrackEvent"),b("stopTrackEvent"),b("startTrackPage"),b("stopTrackPage"),b("flush"),!a.disableExceptionTracking){f="onerror",b("_"+f);var g=e[f];e[f]=function(a,b,d,e,h){var i=g&&g(a,b,d,e,h);return!0!==i&&c["_"+f](a,b,d,e,h),i}}return c }({ instrumentationKey:"dcb460fe-684e-4d39-bfcd-d3a6f2710a32" }); window.appInsights=appInsights,appInsights.queue&&0===appInsights.queue.length&&appInsights.trackPageView(); </script>
    <script>
        window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        'Author': 'Jean-Ian Boutin',
        'ArticleCategory': 'Malware',
        'ArticleSection': 'Research',
        'cookie-bar-hq': true
    });

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMDGSM');
</script>
<script>(function() {
  var _fbq = window._fbq || (window._fbq = []);
  if (!_fbq.loaded) {
    var fbds = document.createElement('script');
    fbds.async = true;
    fbds.src = '//connect.facebook.net/en_US/fbds.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(fbds, s);
    _fbq.loaded = true;
  }
  _fbq.push(['addPixelId', '1518099328403839']);
})();
window._fbq = window._fbq || [];
window._fbq.push(['track', 'PixelInitialized', {}]);
</script>
<noscript><img height="1" width="1" alt="" style="display:none" src="https://www.facebook.com/tr?id=1518099328403839&amp;ev=NoScript" /></noscript>
<meta property="fb:pages" content="56844830907" />
<!-- This site is optimized with the Yoast SEO plugin v9.2 - https://yoast.com/wordpress/plugins/seo/ -->
<title>Nymaim &#8211; obfuscation chronicles | WeLiveSecurity</title>
<link rel="canonical" href="https://www.welivesecurity.com/2013/08/26/nymaim-obfuscation-chronicles/" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Nymaim &#8211; obfuscation chronicles | WeLiveSecurity" />
<meta property="og:description" content="We look at malware delivered by a campaign that has infected thousands of websites around the world - and the various control flow obfuscation techniques that make its analysis as interesting as it is challenging." />
<meta property="og:url" content="https://www.welivesecurity.com/2013/08/26/nymaim-obfuscation-chronicles/" />
<meta property="og:site_name" content="WeLiveSecurity" />
<meta property="article:author" content="https://www.facebook.com/jiboutin" />
<meta property="article:tag" content="Malware" />
<meta property="article:section" content="Malware" />
<meta property="article:published_time" content="2013-08-26T11:02:06+00:00" />
<meta property="article:modified_time" content="2013-08-28T20:19:46+00:00" />
<meta property="og:updated_time" content="2013-08-28T20:19:46+00:00" />
<meta property="og:image" content="https://www.welivesecurity.com/wp-content/uploads/2013/08/handcuffs-1024x739.jpg" />
<meta property="og:image:secure_url" content="https://www.welivesecurity.com/wp-content/uploads/2013/08/handcuffs-1024x739.jpg" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="739" />
<meta property="og:image:alt" content="Handcuffs (Rex)" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:description" content="We look at malware delivered by a campaign that has infected thousands of websites around the world - and the various control flow obfuscation techniques that make its analysis as interesting as it is challenging." />
<meta name="twitter:title" content="Nymaim &#8211; obfuscation chronicles | WeLiveSecurity" />
<meta name="twitter:site" content="@welivesecurity" />
<meta name="twitter:image" content="https://www.welivesecurity.com/wp-content/uploads/2013/08/handcuffs.jpg" />
<meta name="twitter:creator" content="@welivesecurity" />
<!-- / Yoast SEO plugin. -->

<link rel="alternate" type="application/rss+xml" title="WeLiveSecurity RSS 2.0 Feed" href="/rss-configurator/" /><style type="text/css" id="syntaxhighlighteranchor"></style>
        <link id="cookie-style" rel="stylesheet" type="text/css" href="https://assets.esetstatic.com/3PS/cookiebar.min.css">
</head>
<body class="no-js single noimage">
<noscript>
	<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMDGSM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="main">
    <header id="site-header" class="container">
        <div class="row">
            <div class="col-md-4 col-sm-12 col-xs-12 pull-right" id="header-nav">
                <div class="row">
                    <div class="col-xs-12 mobile-search-input">
                        <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                    </div>
                    <div class="hidden-lg hidden-md col-sm-7 col-xs-8 hidden-xxs">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
                    <div class="col-md-8 hidden-sm hidden-xs languages">
                        <div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" id="main-language-picker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    	<span class="text">In English</span>
    	<span class="icomoon icon-icon_arrow"></span>
  	</button>
  	<ul class="dropdown-menu" aria-labelledby="main-language-picker">
            <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
      	</ul>
</div>                    </div>
                    <div class="col-md-4 col-sm-2 col-xs-3 menu-trigger">
                        <div class="menu-btn">
	<span class="text">Menu</span>
	<button type="button" id="menu-trigger" class="tcon tcon-menu--xcross" aria-label="toggle menu">
        <span class="wrapper">
            <span class="tcon-menu__lines" aria-hidden="true"></span>
            <span class="tcon-visuallyhidden">toggle menu</span>
        </span>
    </button>
</div>                    </div>
                    <div class="hidden-lg hidden-md hidden-sm hidden-xs col-xs-2 mobile-search imc">
                        <button class="imc">
                            <span class="icomoon icon-icon_search imc"></span>
                        </button>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 imc" id="main-menu">
                        <nav class="menu clearfix imc">
                            <ul class="col-md-12 col-sm-6 col-xs-6 imc">
                                                                    <li class="">
                                        <a href="/">
                                            All Posts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/research">
                                            Research                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="/category/how-to/">
                                            How To                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/videos/">
                                            Videos                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/media/podcasts/">
                                            Podcasts                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/conference-papers/">
                                            Conference Materials                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/white-papers/">
                                            White Papers                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/threat-reports/">
                                            Threat Reports                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/papers/magazine/">
                                            Magazine                                        </a>
                                    </li>
                                                                    <li class="">
                                        <a href="https://www.welivesecurity.com/our-experts/">
                                            Our Experts                                        </a>
                                    </li>
                                                            </ul>

                            <div class="col-md-12 col-sm-6 col-xs-6 imc">
                                <ul class="languages hidden-lg hidden-md hidden-xxs col-xs-12 imc">
                                        <li>
        <a href="/br/" title="Em Português">
            Em Português        </a>
    </li>
        <li>
        <a href="/fr/" title="En français">
            En français        </a>
    </li>
        <li>
        <a href="/la-es/" title="En Español">
            En Español        </a>
    </li>
        <li>
        <a href="/deutsch/" title="In Deutsch">
            In Deutsch        </a>
    </li>
                                    </ul>
                                <div class="hidden-lg hidden-md col-xs-12 imc">
                                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc dark col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                                </div>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-overlay col-md-12 col-sm-12 col-xs-12 imc">
                        <div class="inner imc"></div>
                    </div>
                </div>
                <div class="row hidden-sm hidden-xs">
                    <form action="https://www.welivesecurity.com/" class="basic-searchform imc  col-md-12 col-sm-10 col-xs-12" method="get" role="search">
	<div class="search-input clearfix">
		<input type="text" name="s" value="" placeholder="Search..." class="imc">
		<button class="imc">
			<span class="icomoon icon-icon_search imc"></span>
		</button>
	</div>
</form>	                </div>
            </div>
            <div class="col-md-5 hidden-sm hidden-xs pull-left" id="header-logo">
                <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                <span class="slogan hidden-sm hidden-xs">
						Award-winning news, views, and insight from the ESET <strong>security community</strong> 
					</span>
            </div>
        </div>
    </header>
        <section id="article-detail">
            <div class="hero-noimage">
	<div class="container promo-text">
		<div class="inner clearfix">
			<div class="col-md-11 col-sm-11 col-xs-12 no-padding">
				<h1>Nymaim &#8211; obfuscation chronicles</h1>
<div class="excerpt">We look at malware delivered by a campaign that has infected thousands of websites around the world - and the various control flow obfuscation techniques that make its analysis as interesting as it is challenging.</div>
<div class="post-meta">
    <div class="wls-authors">
            </div>
    <span class="meta">
		<span class="strong">
			<time datetime="2013-08-26 11:02:06">26 Aug 2013 - 11:02AM</time>
		</span>
			</span>
</div>
			</div>
		</div>
	</div>
</div>	

            <div class="content">
                <div class="social-wrapper" id="social-sharer">
                    <span class="text">Share</span>
	<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2013%2F08%2F26%2Fnymaim-obfuscation-chronicles%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
		<span class="icomoon icon-icon_fb"></span>
	</a>
	<a class="share-twitter" href="https://twitter.com/intent/tweet?&url=https%3A%2F%2Fwww.welivesecurity.com%2F2013%2F08%2F26%2Fnymaim-obfuscation-chronicles%2F&text=Nymaim &#8211; obfuscation chronicles%0A&via=welivesecurity" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
		<span class="icomoon icon-icon_tw"></span>
	</a>
	<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2013%2F08%2F26%2Fnymaim-obfuscation-chronicles%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
		<span class="icomoon icon-icon_in"></span>
	</a>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-md-1 col-sm-1 hidden-xs">

                        </div>
                        <div class="col-md-10 col-sm-10 col-xs-12 formatted">

                            <div class="excerpt noimage">
                                <p>We look at malware delivered by a campaign that has infected thousands of websites around the world &#8211; and the various control flow obfuscation techniques that make its analysis as interesting as it is challenging.</p>
                            </div>

                            <h1>Nymaim – Obfuscation Chronicles</h1>
<h2>Introduction</h2>
<p>Last month, my colleague Sébastien Duquette detailed the <a href="/2013/07/02/the-home-campaign-overstaying-its-welcome/">home campaign</a>, a long-lasting operation consisting of compromised web servers running a malicious Apache module named Darkleech (detected by ESET as Linux/Chapro) that redirects visitors to a Blackhole exploit kit. Sébastien stated that one of the final payloads dropped by this operation was the Win32/Nymaim downloader/ransomware family. In this blog post, we will look at the technical details of this particular malware and how it ends up getting installed on an end-user’s computer. We will also look at the various control flow obfuscation techniques that make its analysis as interesting as it is challenging.</p>
<h2>Trail of infection</h2>
<p>We know that the home campaign has successfully <a href="http://arstechnica.com/security/2013/04/exclusive-ongoing-malware-attack-targeting-apache-hijacks-20000-sites/%20">infected</a> thousands of websites all over the world. While we don’t know exactly how many people got their computer compromised by this campaign, we can assume that their number is fairly large.</p>
<p>A typical infection flow is shown below. When a user visits a Darkleech-compromised website, he eventually sees his computer locked by Win32/Nymaim. As seen in this figure, a malicious program called Pony Loader (detected by ESET as Win32/Fareit) is used to drop the first stage of Win32/Nymaim.</p>
<p style="text-align: center;"><a href="/wp-content/uploads/2013/08/infection_trail.png"><img class="aligncenter  wp-image-24002" alt="Infection trail" src="/wp-content/uploads/2013/08/infection_trail-1024x350.png" width="717" height="245" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/infection_trail-1024x350.png 1024w, https://www.welivesecurity.com/wp-content/uploads/2013/08/infection_trail-300x102.png 300w, https://www.welivesecurity.com/wp-content/uploads/2013/08/infection_trail.png 1212w" sizes="(max-width: 717px) 100vw, 717px" /></a></p>
<p>During the course of our research, we collected several self-signed Pony Loader samples with the certificate shown below.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-23999" alt="Certificate" src="/wp-content/uploads/2013/08/certificate.png" width="406" height="476" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/certificate.png 406w, https://www.welivesecurity.com/wp-content/uploads/2013/08/certificate-255x300.png 255w" sizes="(max-width: 406px) 100vw, 406px" /></p>
<p>We have collected hundreds of Pony Loader samples signed with this certificate. The fact that a self-signed certificate is used is most likely intended to make the file look less suspicious to some heuristic-based engines.</p>
<p>By analyzing these samples, we were able to identify and monitor a static URL hosted on the domain <em>catch-cdn.com</em> used by one Pony Loader sample to fetch the payload to install. While the filename downloaded was always the same (6.exe), we saw that its content varied in nature. We have seen three different malware families on this URL: Win32/Sirefef (aka. ZeroAccess), Win32/Urausy (detected by ESET as Win32/LockScreen) and Win32/Nymaim’s first stage. The following figure shows a timeline of which malware families were downloaded from this static URL over the course of the summer.</p>
<p style="text-align: center;"><a href="/wp-content/uploads/2013/08/timeline.png"><img class="aligncenter  wp-image-24008" alt="Timeline" src="/wp-content/uploads/2013/08/timeline.png" width="725" height="416" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/timeline.png 805w, https://www.welivesecurity.com/wp-content/uploads/2013/08/timeline-300x172.png 300w" sizes="(max-width: 725px) 100vw, 725px" /></a></p>
<p>The algorithm behind the family rotation is still unclear. We can note that several Win32/Urausy samples were available from this URL, but only during the first fifteen days of July. Win32/Sirefef made its appearance in early August while Win32/Nymaim has been present throughout the monitoring period.</p>
<p>The rest of the analysis will focus on Win32/Nymaim’s functionalities.</p>
<h2>Nymaim – First Stage &amp; Common Features</h2>
<p>The Win32/Nymaim infection is a two-stage process. The first stage is merely a downloader and does not stay active on the infected computer. It will try to download Win32/Nymaim’s second stage by contacting a list of hardcoded IP addresses. Once the second stage is downloaded, the first stage just renames itself to a random filename.</p>
<p>In spite of this separation, both stages share several common techniques to hinder malware analysis and we will now take a look at some of them.</p>
<h3>Control Flow Obfuscation</h3>
<p>During execution, call stack modifications are used extensively to hide the true relationships between functions. The following figure highlights two of the most common obfuscated control flow techniques.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-24003" alt="Obfustation example" src="/wp-content/uploads/2013/08/obfuscation_example.png" width="391" height="506" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/obfuscation_example.png 391w, https://www.welivesecurity.com/wp-content/uploads/2013/08/obfuscation_example-231x300.png 231w" sizes="(max-width: 391px) 100vw, 391px" /></p>
<p>The first red square is hiding a simple register push. The next screenshot shows part of the function used to obfuscate this simple instruction.</p>
<p style="text-align: center;"><a href="/wp-content/uploads/2013/08/obfuscation_push_function.png"><img class="aligncenter  wp-image-24006" alt="Obfuscation push function" src="/wp-content/uploads/2013/08/obfuscation_push_function.png" width="761" height="313" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/obfuscation_push_function.png 951w, https://www.welivesecurity.com/wp-content/uploads/2013/08/obfuscation_push_function-300x123.png 300w" sizes="(max-width: 761px) 100vw, 761px" /></a></p>
<p>The constant that is pushed before calling the function above dictates which register gets pushed onto the stack. For example, if 0x34 is pushed as an argument to the function, the equivalent behavior would have been to replace the original “push” and “call” instructions by a simple “push ECX”.</p>
<p>The second red square highlights a control flow obfuscation technique used to hide the true function call. The two constants pushed on the stack are used to derive the address of the function that needs to be called. One example of such a function is shown below.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-24004" alt="fuscation_function" src="/wp-content/uploads/2013/08/obfuscation_function.png" width="431" height="566" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/obfuscation_function.png 431w, https://www.welivesecurity.com/wp-content/uploads/2013/08/obfuscation_function-228x300.png 228w" sizes="(max-width: 431px) 100vw, 431px" /></p>
<p style="text-align: center;">The function depicted above is XORing the two constants and then adding the result to the return value on the stack, but other functions will perform other mathematical operations on these two constants such as subtraction or addition. Since the return value on the stack is changed in this function, instead of returning to the caller, the “retn” opcode at the bottom of the screenshot will in fact jump to the beginning of another function. The return value of the original caller is stored on the stack so that when this function returns, it will go back to the first caller. The figure below illustrates this process more clearly.<br />
<img class="aligncenter" alt="obfuscation_function_drawing" src="/wp-content/uploads/2013/08/obfuscation_function_drawing.png" width="475" height="440" /></p>
<h3>Win32 API Calls Obfuscation</h3>
<p>All calls to the standard Win32 APIs are obfuscated. When a specific function needs to be called, the base address of the DLL containing the function is fetched from the encrypted data section. Each function in its export table is then hashed and compared to the hash of the function name it wants to call. The following screenshot shows the function responsible for computing the function name hash used in the comparison.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-24010" alt="win32api_obfuscation" src="/wp-content/uploads/2013/08/win32api_obfuscation.png" width="286" height="657" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/win32api_obfuscation.png 286w, https://www.welivesecurity.com/wp-content/uploads/2013/08/win32api_obfuscation-130x300.png 130w" sizes="(max-width: 286px) 100vw, 286px" /></p>
<p>When the target function is found, its address is kept in memory and the code will then jump to this address. The return path is also obfuscated. Instead of returning from the API call directly to the malware code, the return address contains an address in ntdll.dll that executes</p>
<p>Call EBX</p>
<p>Before jumping into the API, the stack is modified to return to the correct address in ntdll.dll and EBX contains the true return address. This whole process is highlighted in the figure below.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-24011" alt="win32api_obfuscation_drawing" src="/wp-content/uploads/2013/08/win32api_obfuscation_drawing.png" width="550" height="715" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/win32api_obfuscation_drawing.png 550w, https://www.welivesecurity.com/wp-content/uploads/2013/08/win32api_obfuscation_drawing-230x300.png 230w" sizes="(max-width: 550px) 100vw, 550px" /></p>
<p>Not only is it hard to follow while single-stepping, but this will also impede the debugger “execute till return” functionality as there is no return that goes back to the user code.</p>
<h3>Strings Encryption</h3>
<p style="text-align: left;">All strings in the binary are stored encrypted. The function to decrypt the strings can be found in the next figure.</p>
<p><img class="aligncenter size-full wp-image-24007" alt="string_decryption" src="/wp-content/uploads/2013/08/string_decryption.png" width="327" height="654" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/string_decryption.png 327w, https://www.welivesecurity.com/wp-content/uploads/2013/08/string_decryption-150x300.png 150w" sizes="(max-width: 327px) 100vw, 327px" /></p>
<p>Each character is encrypted depending on its position in the data section. The decryption routine is called for each character and the strings are decrypted only when they are needed.</p>
<h2>Nymaim – Second Stage</h2>
<p>Win32/Nymaim’s second stage uses the same obfuscation techniques as the first stage, but its functionalities are expanded to include persistence, dropper capabilities and a locking mechanism.</p>
<p>Persistence is achieved by adding the executable path to the registry key “<em>Software\Microsoft\Windows NT\CurrentVersion\Winlogon\shell</em>”</p>
<p>Our analysis revealed that occasionally, the second stage would download and install Win32/Sirefef on the machine. When this occurs, both Win32/Sirefef and Win32/Nymaim are persistent on the computer. Thus, additional malware can be downloaded at a future time by Win32/Nymaim.</p>
<p>When Win32/Nymaim’s second stage <i>does</i> lock the computer, it will download the HTML locking screen, but will also customize it by gathering some information on the infected system, such as media files or active torrent clients. The resulting lock screen becomes much more believable to the user.</p>
<p>More specifically, the malware searches the active processes for the following torrent clients:</p>
<p>&#8211;          Azureus</p>
<p>&#8211;          Utorrent</p>
<p>&#8211;          Mediaget</p>
<p>&#8211;          Bittorrent</p>
<p>&#8211;          Bitcomet</p>
<p>It will also search for files with the following extensions: .doc, .xls, .psd, .bmp, .jpg, .mpg, .mov, .rtf, .fla and .mp3. The gathered information will be stored in a file called compdata.js that will be included by the locker HTML code. An example of a compdata.js file is shown below.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-24000" alt="compdata_js_edited" src="/wp-content/uploads/2013/08/compdata_js_edited.png" width="580" height="149" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/compdata_js_edited.png 580w, https://www.welivesecurity.com/wp-content/uploads/2013/08/compdata_js_edited-300x77.png 300w" sizes="(max-width: 580px) 100vw, 580px" /></p>
<p>The HTML code, scripts and images used to render the lockscreen are stored in the “Documents and Settings\[user_name]\Local Settings\Temp” folder on a Windows XP system. To lock the computer, the malicious code will create a window covering the whole screen. It will also spawn at least two threads. One will monitor the current running processes and will terminate <em>taskmgr.exe</em> (Task manager) if it is active. Another one will make sure that the current desktop is the one created by the malware, otherwise it will switch to that desktop. This behavior is very similar to the Urausy ransomware described by <a href="https://blog.avast.com/2013/07/24/urausy-lockscreen-your-computer-will-remain-locked-for-3-days-11-hours-and-20-minutes/">AVAST</a>. The US lockscreen design (retrieved 2013/08/20) is shown in the screenshot below. As with most ransomware, the images are customized depending on the infected computer location.</p>
<p style="text-align: center;"><a href="/wp-content/uploads/2013/08/usa_lock_edited.png"><img class="aligncenter size-large wp-image-24009" alt="usa_lock_edited" src="/wp-content/uploads/2013/08/usa_lock_edited-596x1024.png" width="596" height="1024" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/usa_lock_edited-596x1024.png 596w, https://www.welivesecurity.com/wp-content/uploads/2013/08/usa_lock_edited-174x300.png 174w, https://www.welivesecurity.com/wp-content/uploads/2013/08/usa_lock_edited.png 629w" sizes="(max-width: 596px) 100vw, 596px" /></a></p>
<p>When the second stage is installed on a machine, it will communicate its bot ID to the server which will then decide what happens next. Throughout our research, we found that once a particular system has been locked, it is not possible to lock it again. The server seems to keep host information and will not send the HTML code required to lock the computer if it has already been served once to the requesting bot. After analysis, it appears that the computer ID is generated through the registry key “<em>HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\MachineGuid</em>” and simply changing this value enables the same computer to be locked at will, regardless of the bot’s IP address.</p>
<h2>Conclusion</h2>
<p>The home campaign has been delivering the Win32/Nymaim ransomware since at least March 2013. In this blog post, we saw that several malware families were dropped by this campaign. Our current understanding of the potential malware families delivered is shown in the next figure.</p>
<p style="text-align: center;"><img class="aligncenter size-full wp-image-24001" alt="download_graph" src="/wp-content/uploads/2013/08/download_graph.png" width="530" height="636" srcset="https://www.welivesecurity.com/wp-content/uploads/2013/08/download_graph.png 530w, https://www.welivesecurity.com/wp-content/uploads/2013/08/download_graph-250x300.png 250w" sizes="(max-width: 530px) 100vw, 530px" /></p>
<p>Win32/Nymaim is a complex piece of malware that is used both as a downloader and a locker. It hinders malware analysis by implementing several control flow obfuscation techniques. For the end user though, the result is always the same: a thorough cleaning of their compromised computer is necessary. Stay tuned for the next blog post containing more information on this very interesting malware.</p>
<p><i>Special thanks to Mathieu Lavoie for his contribution to this analysis.</i></p>
<p><b>SHA1 hashes of analyzed files</b></p>
<p><em>Pony Loader:               ce6ae8bca368be676d6adae57d632f42187d762c</em></p>
<p><em>Nymaim – first stage:      c8a5bafb51039ec9d3c1291c1ebfe4886c81130d</em></p>
<p><em>Nymaim – second stage:     acef628f6d33e31c5f03ed6b386fbe2091a7f110</em></p>

                            
                                                            <div class="dot">
                                    <span class="icomoon icon-icon_article_dot"></span>
                                </div>

                                <div class="meta">
                                    <div class="wls-authors wls-authors-footer">
                                                                            </div>
                                    <span class="strong">
								        <time datetime="2013-08-26 11:02:06">26 Aug 2013 - 11:02AM</time>
                                    </span>
                                </div>
                            
                            <div class="widgets row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12 no-padding">
                                        <h3><span class="text">Newsletter</span></h3>
                                    </div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12 newsletter-wrapper">
                                    			
		<div class="heading-line col-md-12 no-padding sidebar-item clearfix">
			<h3>
				<span class="text">Newsletter</span>
			</h3>

			<form action="//liondigital.us3.list-manage.com/subscribe/post?u=b76f82b1cc198ab1d80665c99&amp;id=102b0810e2" class="basic-searchform col-md-12 col-sm-12 col-xs-12 no-padding newsletter" method="post" role="search">
				<div class="search-input clearfix">
					<input type="text" name="email" value="" placeholder="Email...">
					<button>
						Submit					</button>
				</div>
			</form>		
		</div>
                                </div>
                            </div>

                                                            <div class="similar-articles row">
                                    <div class="heading-line col-md-12 col-sm-12 col-xs-12">
                                        <h3><span class="text">Similar Articles</span></h3>
                                    </div>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/cybercrime/" class="category-tag-btn">Cybercrime</a>                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/fbi-cybercrime-losses-2020-ic3-623x432.jpg"
                                                         alt="Nymaim &#8211; obfuscation chronicles">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/18/fbi-cybercrime-losses-topped-us42billion-2020/">
                                                    FBI: Cybercrime losses topped US$4.2 billion in 2020                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/03/exchange-servers-under-siege-10-apt-groups-623x432.jpg"
                                                         alt="Nymaim &#8211; obfuscation chronicles">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/">
                                                    Exchange servers under siege from at least 10 APT groups                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/apple-m1-macs-malware-1-623x432.jpg"
                                                         alt="Nymaim &#8211; obfuscation chronicles">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/18/malware-authors-already-taking-aim-apple-m1-macs/">
                                                    Malware authors already taking aim at Apple M1 Macs                                                </a>
                                            </h4>
                                        </article>
                                                                            <article class="col-md-3 col-sm-3 col-xs-3">
                                            <div class="img-wrapper">
                                                <a href="https://www.welivesecurity.com/category/malware/" class="category-tag-btn">Malware</a>                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/"
                                                   class="related-article-thumb">
                                                    <img class="col-xs-12 no-padding clickable"
                                                         src="https://www.welivesecurity.com/wp-content/uploads/2021/02/eset-kobalos-hpc-high-performance-computing-malware-research-623x432.jpg"
                                                         alt="Nymaim &#8211; obfuscation chronicles">
                                                </a>
                                            </div>
                                            <h4>
                                                <a href="https://www.welivesecurity.com/2021/02/02/kobalos-complex-linux-threat-high-performance-computing-infrastructure/">
                                                    Kobalos – A complex Linux threat to high performance computing infrastructure                                                </a>
                                            </h4>
                                        </article>
                                                                    </div>
                            
                            <div class="comments row">
                                <div class="heading-line col-xs-12">
                                    <h3><span class="text">Discussion</span></h3>
                                                                            
<div id="disqus_thread"></div>
                                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    	</div> 	<footer id="site-footer">
		<div class="container">
			<div class="row">
				<div class="col-md-2">
                    <div class="hidden-sm hidden-xs">
                        <div class="logo-wrapper footer clearfix">
                            <div class="dark clearfix">
                                <a href="https://www.welivesecurity.com/" class="wls">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-1.svg" alt="Welivesecurity.com">
                                </a>
                                <a href="https://www.eset.com" class="eset">
                                    <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-footer-2.svg" alt="by ESET">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="hidden-lg hidden-md">
                        <div class="logo-wrapper clearfix">
    <div class="dark clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-dark-header-2.svg" alt="by ESET">
        </a>
    </div>
    <div class="light clearfix">
        <a href="https://www.welivesecurity.com/" class="wls">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-1.svg" alt="Welivesecurity.com">
        </a>
        <a href="https://www.eset.com" class="eset">
            <img src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/img/new-logo/eset-wls-light-header-2.svg" alt="by ESET">
        </a>
    </div>
</div>                    </div>
				</div>
				<nav id="footer" class="clearfix">
											<div class="mobile-block">
																<div class="col-md-2 col-md-offset-2">
										<ul>
																							<li>
													<a href="/">Home</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/about-us/">About Us</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/contact-us/">Contact Us</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/sitemap/">Sitemap</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/our-experts/">Our Experts</a>
												</li>
																							<li>
													<a href="https://eset.com">ESET</a>
												</li>
																					</ul>
									</div>
													</div>
											<div class="mobile-block">
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/research/">Research</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/category/how-to/">How To</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/categories/">Categories</a>
												</li>
																					</ul>
									</div>
																<div class="col-md-2 ">
										<ul>
																							<li>
													<a href="https://www.welivesecurity.com/rss-configurator/">RSS Configurator</a>
												</li>
																							<li>
													<a href="https://www.welivesecurity.com/news-widget-generator/">News Widget</a>
												</li>
																					</ul>
									</div>
													</div>
									</nav>
			</div>
			<div class="row">
				<div class="col-md-12 legal clearfix">
					<div class="wrap clearfix">
													<span>
								<a href="https://www.welivesecurity.com/privacy/">
									Privacy policy								</a>
							</span>
													<span>
								<a href="https://www.welivesecurity.com/legal-information/">
									Legal Information								</a>
							</span>
											</div>
					<span class="copyright pull-right">Copyright &copy; ESET, All Rights Reserved</span>
				</div>
							</div>
		</div>
	</footer>
	
	<button id="back-to-top" class="animated-scroll" data-target="absoluteTop">
		<span class="icomoon icon-icon_arrow"></span>
		<span class="text">Back to top</span>
	</button>

			<div class="social-wrapper-mobile hidden-lg hidden-md hidden-sm" id="mobile-article-sharer">
			<div class="col-xs-12">
				<div class="icons" style="text-align: center;">
											<a class="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.welivesecurity.com%2F2013%2F08%2F26%2Fnymaim-obfuscation-chronicles%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Facebook">
							<span class="icomoon icon-icon_fb"></span>
						</a>
											<a class="share-twitter" href="https://twitter.com/intent/tweet?https%3A%2F%2Fwww.welivesecurity.com%2F2013%2F08%2F26%2Fnymaim-obfuscation-chronicles%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Twitter">
							<span class="icomoon icon-icon_tw"></span>
						</a>
											<a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.welivesecurity.com%2F2013%2F08%2F26%2Fnymaim-obfuscation-chronicles%2F" target="blank" data-toggle="tooltip" data-placement="top" data-original-title="Share on Linkedin">
							<span class="icomoon icon-icon_in"></span>
						</a>
									</div>
			</div>
		</div>
	
	<script>
		var baseUrl = "https://www.welivesecurity.com/";
	</script>
	
			<script>
            !function(){if(-1==window.document.cookie.indexOf("user_rec=1")){function e(e,o){var t=document.createElement("img");t.setAttribute("style","display:none"),t.src=e+o,window.document.body.appendChild(t)}function o(){d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Default%20status&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=defaultStatus&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c)}function t(){console.log("GA and GTM are loaded."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=11",e(u,a),e(s,c)}function n(){var e=new Date;e.setTime(e.getTime()+63072e6);var o="expires="+e.toUTCString();window.document.cookie="user_rec=1; "+o+"; path=/"}var d,a,c,i,r,l="UA-76266002-27",g=window.location.href,s="https://cdn1.esetstatic.com/ESET/INT/assets/img/check.png",u="https://www.google-analytics.com/collect",w="wls",m=0,h=function e(){i=window.ga&&ga.create?1:0,r=window.google_tag_manager?1:0,m++,console.log("Timer: ",m),h=setTimeout(e,500)};window.document.addEventListener&&(d=1e6*Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=Script%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=scriptLoaded&z="+Math.floor(1e6*Math.random(0,1)),e(u,a),e(s,c),window.addEventListener("beforeunload",o),window.ga&&ga.create&&window.google_tag_manager?(t(),window.removeEventListener("beforeunload",o),n()):(setTimeout(h,500),setTimeout(function(){clearTimeout(h),i&&r?t():i&&!r?(console.log("GA is loaded and GTM is blocked."),d=ga.getAll()[0].get("clientId"),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20loaded,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=10",e(u,a),e(s,c)):!i&&r?(console.log("GA is blocked and GTM is loaded."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20loaded&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=01",e(u,a),e(s,c)):i||r||(console.log("GA is blocked and GTM is blocked."),d||Math.random(1e6,9999999),a="?v=1&cid="+d+"&tid="+l+"&dl="+g+"&t=event&ec=Tracking%20check%20-%20recurring&ea=GA%20blocked,%20GTM%20blocked&ni=1&cd1="+w+"&aip=1&z="+Math.floor(1e6*Math.random(0,1)),c="?country=wls&gcode=00",e(u,a),e(s,c)),window.removeEventListener("beforeunload",o),n()},1e4)))}}();
		</script>
	
	<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/build/js/main-0ba0c3843d.js"></script>
    <!-- Version: v1.1.76.32619db9.pro-azeu -->
    		<script type="text/javascript">
			var disqus_config = function () { 
				this.language = "en";
			};
			var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":"", "numsVisible": false};
			var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
		</script>
		<script src="https://www.welivesecurity.com/wp-content/themes/eset-wls-2018/assets/static/js/crayon.min.js"></script>

			
		
    <script>
    	Main.init();
    </script>

    <script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"welivesecurity"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_count.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"23998 \/?p=23998","disqusShortname":"welivesecurity","disqusTitle":"Nymaim \u2013 obfuscation chronicles","disqusUrl":"https:\/\/www.welivesecurity.com\/2013\/08\/26\/nymaim-obfuscation-chronicles\/","postId":"23998"};
/* ]]> */
</script>
<script type='text/javascript' src='https://www.welivesecurity.com/wp-content/plugins/disqus-comment-system/public/js/comment_embed.js?ver=3.0.16'></script>
    <script src="https://assets.esetstatic.com/3PR/app.min.js"></script>
  </body>
</html>